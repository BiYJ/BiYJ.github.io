<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title> Websocket		 | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden"> Websocket		</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title"> Websocket		</h1><div class="post-meta"><a href="/2019/03/22/websocket/#comments" class="comment-count"></a><p><span class="date">Mar 22, 2019</span><span><a href="/categories/计算机网络/" class="category">计算机网络</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>原文：<a href="https://www.jianshu.com/p/bcefda55bce4" target="_blank" rel="noopener">微信、QQ这类 IM app 怎么做–谈谈Websocket</a>、<a href="https://github.com/Tencent/mars" target="_blank" rel="noopener">微信开源的跨平台终端组件</a></p>
<p>目录</p>
<ol>
<li>WebSocket 使用场景</li>
<li>WebSocket 诞生由来</li>
<li>WebSocket 协议原理</li>
<li>WebSocket 和 Socket 的区别与联系</li>
<li>iOS 平台有哪些 WebSocket 和 Socket 的开源框架</li>
<li>iOS 平台如何实现 WebSocket 协议</li>
<li>总结</li>
</ol>
<h5 id="一、WebSocket-的使用场景"><a href="#一、WebSocket-的使用场景" class="headerlink" title="一、WebSocket 的使用场景"></a>一、WebSocket 的使用场景</h5><p>1、社交聊天</p>
<p>这类聊天 app 的特点是低延迟，高即时。即时性是要求最高的。</p>
<p>2、弹幕</p>
<p>发弹幕需要实时显示，也需要和聊天一样，需要即时。</p>
<p>3、多玩家游戏</p>
<p>4、协同编辑</p>
<p>现在很多开源项目都是分散在世界各地的开发者一起协同开发，此时就会用到版本控制系统，比如 Git、SVN 去合并冲突。但是如果有一份文档，支持多人实时在线协同编辑，那么此时就会用到比如 WebSocket 了，它可以保证各个编辑者都在编辑同一个文档，此时不需要用到 Git、SVN 这些版本控制，因为在协同编辑界面就会实时看到对方编辑了什么。</p>
<p>5、股票基金实时报价</p>
<p>如果采用的网络架构无法满足实时性，那么就会给客户带来巨大的损失。</p>
<p>6、体育实况更新</p>
<p>7、视频会议/聊天</p>
<p>8、基于位置的应用</p>
<p>越来越多的开发者借用移动设备的 GPS 功能来实现他们基于位置的网络应用。如果你一直记录用户的位置（比如运行应用来记录运动轨迹)，你可以收集到更加细致化的数据。</p>
<p>9、在线教育</p>
<p>Websocket 是个不错的选择，可以视频聊天、即时聊天以及其与别人合作一起在网上讨论问题。</p>
<p>10、智能家居</p>
<p>总结：从上面我列举的这些场景来看，一个共同点就是，高实时性！</p>
<h5 id="二、WebSocket-诞生由来"><a href="#二、WebSocket-诞生由来" class="headerlink" title="二、WebSocket 诞生由来"></a>二、WebSocket 诞生由来</h5><p>1、最开始的轮询 Polling 阶段</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1194012-ce4df238336909a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/954/format/webp" alt="image"></p>
<p>这种方式是不适合获取实时信息的，客户端和服务器之间会一直进行连接，每隔一段时间就询问一次。客户端会轮询，有没有新消息。这种方式连接数会很多，一个接受，一个发送。而且每次发送请求都会有 Http 的 Header，会很耗流量，也会消耗 CPU 的利用率。</p>
<p>2、改进版的长轮询 Long polling 阶段</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1194012-6ca608d5a37095e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/959/format/webp" alt="2"></p>
<p>长轮询是对轮询的改进版，客户端发送 HTTP 给服务器之后，有没有新消息。如果没有新消息，就一直等待；当有新消息的时候，才会返回给客户端。在某种程度上减小了网络带宽和 CPU 利用率等问题。</p>
<p>但是这种方式还是有一种弊端：假设服务器端的数据更新速度很快，服务器在传送一个数据包给客户端后必须等待客户端的下一个 Get 请求到来，才能传递第二个更新的数据包给客户端，那么这样的话，客户端显示实时数据最快的时间为 2×RTT（往返时间），而且如果在网络拥塞的情况下，这个时间用户是不能接受的，比如在股市的的报价上。另外，由于 http 数据包的头部数据量往往很大（通常有 400 多个字节），但是真正被服务器需要的数据却很少（有时只有 10 个字节左右），这样的数据包在网络上周期性的传输，难免对网络带宽是一种浪费。</p>
<p>3、WebSocket 诞生</p>
<p>现在急需的需求是能支持客户端和服务器端的双向通信，而且协议的头部又没有 HTTP 的 Header 那么大。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1194012-b88b2623a2e4a8ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/504/format/webp" alt="3"></p>
<p>上图就是 Websocket 和 Polling 的区别，从图中可以看到 Polling 里面客户端发送了好多 Request，而下图，只有一个Upgrade，非常简洁高效。消耗方面的比较：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1194012-f1f91e25b9635701.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/503/format/webp" alt="4"></p>
<p>蓝色的柱状图，是 Polling 轮询消耗的流量，这次测试，HTTP 请求和响应头信息开销总共包括 871 字节。当然每次测试不同的请求，头的开销不同。这次测试都以 871 字节的请求来测试。</p>
<p>**Use case A: **1,000 clients polling every second: Network throughput is (871 x 1,000) = 871,000 bytes = 6,968,000 bits per second (6.6 Mbps)<br>**Use case B: **10,000 clients polling every second: Network throughput is (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits per second (66 Mbps)<br>**Use case C: **100,000 clients polling every 1 second: Network throughput is (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits per second (665 Mbps)</p>
<p>而 Websocket 的 Frame 是 just two bytes of overhead instead of 871，仅仅用 2 个字节就代替了轮询的 871 字节！</p>
<p>**Use case A: **1,000 clients receive 1 message per second: Network throughput is (2 x 1,000) = 2,000 bytes = 16,000 bits per second (0.015 Mbps)<br>**Use case B: **10,000 clients receive 1 message per second: Network throughput is (2 x 10,000) = 20,000 bytes = 160,000 bits per second (0.153 Mbps)<br>**Use case C: **100,000 clients receive 1 message per second: Network throughput is (2 x 100,000) = 200,000 bytes = 1,600,000 bits per second (1.526 Mbps)</p>
<p>相同的每秒客户端轮询的次数，当次数高达 10W/s 的高频率次数的时候，Polling 轮询需要消耗 665Mbps，而 Websocket 仅仅只花费了 1.526Mbps，将近 435 倍。</p>
<h5 id="三、谈谈-WebSocket-协议原理"><a href="#三、谈谈-WebSocket-协议原理" class="headerlink" title="三、谈谈 WebSocket 协议原理"></a>三、谈谈 WebSocket 协议原理</h5><p>Websocket 是应用层第七层上的一个应用层协议，它必须依赖 <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">HTTP 协议进行一次握手</a>，握手成功后，数据就直接从 TCP 通道传输，与 HTTP 无关了。</p>
<blockquote>
<p>“它必须依赖 HTTP 协议进行一次握手”</p>
<p>其他的 Socket 都是通过 ip + 端口连接，但是客户端写死 ip 和端口是很不明智的，通过域名解析在客户端与服务端之间建立桥梁，服务端就能更加灵活。WebSocket 里能通过 url 建立连接，http 一次握手有可能是用来域名解析用的。（待验证）</p>
</blockquote>
<p>Websocket 的数据传输是以 frame 形式传输的，比如会将一条消息分为几个 frame，按照先后顺序传输出去。这样做会有几个好处：</p>
<ol>
<li>大数据的传输可以分片传输，不用考虑到数据大小导致的长度标志位不足够的情况。</li>
<li><p>和 http 的 chunk 一样，可以边生成数据边传递消息，即提高传输效率。</p>
<p>0                   1                   2                   3<br>0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<br>+-+-+-+-+——-+-+————-+——————————-+<br>|F|R|R|R| opcode|M| Payload len |    Extended payload length    |<br>|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |<br>|N|V|V|V|       |S|             |   (if payload len==126/127)   |<br>| |1|2|3|       |K|             |                               |<br>+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +<br>|     Extended payload length continued, if payload len == 127  |<br>+ - - - - - - - - - - - - - - - +——————————-+<br>|                               |Masking-key, if MASK set to 1  |<br>+——————————-+——————————-+<br>| Masking-key (continued)       |          Payload Data         |<br>+-------------------------------- - - - - - - - - - - - - - - - +<br>:                     Payload Data continued …                :<br>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +<br>|                     Payload Data continued …                |<br>+—————————————————————+</p>
</li>
</ol>
<pre><code>FIN      1bit 表示信息的最后一帧，flag，也就是标记符
RSV 1-3  1bit each 以后备用的 默认都为 0
Opcode   4bit 帧类型，稍后细说
Mask     1bit 掩码，是否加密数据，默认必须置为1 （这里很蛋疼）
Payload  7bit 数据的长度
Masking-key      1 or 4 bit 掩码
Payload data     (x + y) bytes 数据
Extension data   x bytes  扩展数据
Application data y bytes  程序数据
</code></pre><p>具体的规范，还请看官网的<a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC 6455</a>文档给出的详细定义。这里还有一个<a href="https://legacy.gitbook.com/book/chenjianlong/rfc-6455-websocket-protocol-in-chinese/details" target="_blank" rel="noopener">翻译版本</a></p>
<h5 id="四、WebSocket-和-Socket-的区别与联系"><a href="#四、WebSocket-和-Socket-的区别与联系" class="headerlink" title="四、WebSocket 和 Socket 的区别与联系"></a>四、WebSocket 和 Socket 的区别与联系</h5><p>首先 <a href="https://en.wikipedia.org/wiki/Network_socket" target="_blank" rel="noopener">Socket</a> 其实并不是一个协议。它工作在 OSI 模型会话层（第 5 层），是为了方便大家直接使用更底层协议（一般是 <a href="http://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank" rel="noopener">TCP</a> 或 <a href="http://en.wikipedia.org/wiki/User_Datagram_Protocol" target="_blank" rel="noopener">UDP</a> ）而存在的一个抽象层。Socket 是对 TCP/IP 协议的封装，Socket本身并不是协议，而是一个调用接口（API）。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1194012-d35653654be833ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640/format/webp" alt="5"></p>
<p>Socket 通常也称作”套接字”，用于描述 IP 地址和端口，是一个通信链的句柄。</p>
<p>网络上的两个程序通过一个双向的通讯连接实现数据的交换，这个双向链路的一端称为一个 Socket，一个 Socket 由一个 IP 地址和一个端口号唯一确定。应用程序通常通过”套接字”向网络发出请求或者应答网络请求。</p>
<p>Socket 在通讯过程中，服务端监听某个端口是否有连接请求，客户端向服务端发送连接请求，服务端收到连接请求向客户端发出接收消息，这样一个连接就建立起来了。客户端和服务端也都可以相互发送消息与对方进行通讯，直到双方连接断开。</p>
<p>所以基于 WebSocket 和基于 Socket 都可以开发出 IM 社交聊天类的 app。</p>
<h5 id="五、iOS-平台的-WebSocket-和-Socket-开源框架"><a href="#五、iOS-平台的-WebSocket-和-Socket-开源框架" class="headerlink" title="五、iOS 平台的 WebSocket 和 Socket 开源框架"></a>五、iOS 平台的 WebSocket 和 Socket 开源框架</h5><p>Socket 开源框架有：<a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank" rel="noopener">CocoaAsyncSocket</a>，<a href="https://github.com/socketio/socket.io-client-swift" target="_blank" rel="noopener">socketio/socket.io-client-swift</a><br>WebSocket 开源框架有：<a href="https://github.com/facebook/SocketRocket" target="_blank" rel="noopener">facebook/SocketRocket</a>，<a href="https://github.com/tidwall/SwiftWebSocket" target="_blank" rel="noopener">tidwall/SwiftWebSocket</a></p>
<h5 id="六、iOS-平台如何实现-WebSocket-协议"><a href="#六、iOS-平台如何实现-WebSocket-协议" class="headerlink" title="六、iOS 平台如何实现 WebSocket 协议"></a>六、iOS 平台如何实现 WebSocket 协议</h5><p>来看看 facebook/SocketRocket 的实现方法。首先这是 SRWebSocket 定义的一些成员变量</p>
<p>@property (nonatomic, weak) id <srwebsocketdelegate> delegate;<br>/**<br> A dispatch queue for scheduling the delegate calls. The queue doesn’t need be a serial queue.</srwebsocketdelegate></p>
<p> If `nil` and `delegateOperationQueue` is `nil`, the socket uses main queue for performing all delegate method calls.<br> */<br>@property (nonatomic, strong) dispatch_queue_t delegateDispatchQueue;<br>/**<br> An operation queue for scheduling the delegate calls.</p>
<p> If `nil` and `delegateOperationQueue` is `nil`, the socket uses main queue for performing all delegate method calls.<br> <em>/<br>@property (nonatomic, strong) NSOperationQueue </em>delegateOperationQueue;<br>@property (nonatomic, readonly) SRReadyState readyState;<br>@property (nonatomic, readonly, retain) NSURL <em>url;<br>@property (nonatomic, readonly) CFHTTPMessageRef receivedHTTPHeaders;<br>// Optional array of cookies (NSHTTPCookie objects) to apply to the connections<br>@property (nonatomic, copy) NSArray&lt;NSHTTPCookie </em>&gt; *requestCookies;</p>
<p>// This returns the negotiated protocol.<br>// It will be nil until after the handshake completes.<br>@property (nonatomic, readonly, copy) NSString *protocol;</p>
<p>SRWebSocket 的一些方法：</p>
<p>// Protocols should be an array of strings that turn into Sec-WebSocket-Protocol.<br>- (instancetype)initWithURLRequest:(NSURLRequest <em>)request;<br>- (instancetype)initWithURLRequest:(NSURLRequest </em>)request protocols:(NSArray<nsstring *> <em>)protocols;<br>- (instancetype)initWithURLRequest:(NSURLRequest </em>)request protocols:(NSArray<nsstring *> *)protocols allowsUntrustedSSLCertificates:(BOOL)allowsUntrustedSSLCertificates;</nsstring></nsstring></p>
<p>// Some helper constructors.<br>- (instancetype)initWithURL:(NSURL <em>)url;<br>- (instancetype)initWithURL:(NSURL </em>)url protocols:(NSArray<nsstring *> <em>)protocols;<br>- (instancetype)initWithURL:(NSURL </em>)url protocols:(NSArray<nsstring *> *)protocols allowsUntrustedSSLCertificates:(BOOL)allowsUntrustedSSLCertificates;</nsstring></nsstring></p>
<p>// By default, it will schedule itself on +[NSRunLoop SR_networkRunLoop] using defaultModes.<br>- (void)scheduleInRunLoop:(NSRunLoop <em>)aRunLoop forMode:(NSString </em>)mode;<br>- (void)unscheduleFromRunLoop:(NSRunLoop <em>)aRunLoop forMode:(NSString </em>)mode;</p>
<p>// SRWebSockets are intended for one-time-use only.  Open should be called once and only once.<br>- (void)open;<br>- (void)close;<br>- (void)closeWithCode:(NSInteger)code reason:(NSString *)reason;</p>
<p>///————————————–</p>
<p>#pragma mark Send<br>///————————————–</p>
<p>//下面是4个发送的方法<br>/**<br> Send a UTF-8 string or binary data to the server.</p>
<p> @param message UTF-8 String or Data to send.</p>
<p> @deprecated Please use `sendString:` or `sendData` instead.<br> */<br>- (void)send:(id)message __attribute__((deprecated(“Please use `sendString:` or `sendData` instead.”)));<br>- (void)sendString:(NSString <em>)string;<br>- (void)sendData:(NSData </em>)data;<br>- (void)sendPing:(NSData *)data;</p>
<p>@end</p>
<p>5 种状态的代理方法：</p>
<p>///————————————–</p>
<p>#pragma mark - SRWebSocketDelegate<br>///————————————–<br>@protocol SRWebSocketDelegate <nsobject></nsobject></p>
<p>- (void)webSocket:(SRWebSocket *)webSocket didReceiveMessage:(id)message;</p>
<p>@optional<br>- (void)webSocketDidOpen:(SRWebSocket <em>)webSocket;<br>- (void)webSocket:(SRWebSocket </em>)webSocket didFailWithError:(NSError <em>)error;<br>- (void)webSocket:(SRWebSocket </em>)webSocket didCloseWithCode:(NSInteger)code reason:(NSString <em>)reason wasClean:(BOOL)wasClean;<br>- (void)webSocket:(SRWebSocket </em>)webSocket didReceivePong:(NSData *)pongPayload;</p>
<p>// Return YES to convert messages sent as Text to an NSString. Return NO to skip NSData -&gt; NSString conversion for Text messages. Defaults to YES.<br>- (BOOL)webSocketShouldConvertTextFrameToString:(SRWebSocket *)webSocket;<br>@end</p>
<p>didReceiveMessage 方法是必须实现的，用来接收消息的。下面 4 个 did 方法分别对应着 Open、Fail、Close、ReceivePong 不同状态的代理方法。</p>
<p>方法就上面这些了，实际来看看代码怎么写</p>
<p>{<br>    /* 先初始化 Websocket 连接，注意此处 ws:// 或者 wss:// 连接有且最多只能有一个，这个是 Websocket 协议规定的  <em>/<br>    NSURL </em> url = [NSURL URLWithString:[NSString stringWithFormat:@”%@://%@:%zd/ws”, serverProto, serverIP, serverPort]];</p>
<pre><code>self.ws = \[\[SRWebSocket alloc\] initWithURLRequest:\[NSURLRequest requestWithURL:url\]\];
self.ws.delegate = delegate;
\[self.ws open\];

// 发送消息
\[self.ws send:message\];
</code></pre><p>}</p>
<p>/// 接收消息以及其他 3 个代理方法<br>/**<br> * @brief  接受消息。这里接受服务器返回的数据，方法里面就应该写处理数据，存储数据的方法。<br> */<br>- (void)webSocket:(SRWebSocket <em>)webSocket didReceiveMessage:(id)message<br>{<br>    NSDictionary </em> data = [NetworkUtils decodeData:message];<br>    if (!data)<br>        return;<br>}</p>
<p>/**<br> * @brief  Websocket 刚刚 Open<br> * @discussion  就像微信刚刚连接中，会显示连接中，当连接上了，就不显示连接中了，取消显示连接的方法就应该写在这里面<br> */<br>- (void)webSocketDidOpen:(SRWebSocket *)webSocket<br>{<br>    // Open = silent ping<br>    [self.ws receivedPing];<br>}</p>
<p>/**<br> *  @brief  关闭 Websocket<br> */<br>- (void)webSocket:(SRWebSocket <em>)webSocket didCloseWithCode:(NSInteger)code reason:(NSString </em>)reason wasClean:(BOOL)wasClean<br>{<br>    [self failedConnection:NSLS(Disconnected)];<br>}</p>
<p>/**<br> * @brief  连接 Websocket 失败，这里面一般都会写重连的方法<br> */<br>- (void)webSocket:(SRWebSocket <em>)webSocket didFailWithError:(NSError </em>)error<br>{<br>    [self failedConnection:NSLS(Disconnected)];<br>}</p>
<h5 id="七、问题"><a href="#七、问题" class="headerlink" title="七、问题"></a>七、问题</h5><p>对于 websocket 的优点上面解释得很清楚。</p>
<p>1、它的缺点呢？</p>
<p>其中一个：因为其连接的 persistent（保持）特点，必然占据大量的资源（服务器以及客户端），因此对于并发量大的情况下，资源的消耗是很可观的。这个需要根据实际情况抉择，损耗相对于优点来说，是否可以忽略。</p>
<p>2、webSocket 心跳，怎么处理？</p>
<p>每隔几秒发一次，和 socket 差不多。</p>
<p>3、Websocket 实现视频通话，语音通话，有什么好的解决方案吗？</p>
<p>可以看看 webRTC</p>
<p>4、websocket 可以正常连接，不过连接成功两分钟后就会断掉，后台没有提供心跳接口，像这样的问题应该怎么处理？目前临时处理是断开后置空 websocket，然后重新连接，感觉这样太不好了，而且会有较低概率出现闪退，回复是由于 NSAssert(_readyState == SR_CONNECTING, @”Cannot call -(void)open on SRWebSocket more than once”);</p>
<p>要搞清楚为什么会断开，是服务器的问题还是客户端的问题。</p>
<p>一般都是需要用心跳来维持的，直接置空确实是有闪退的危险的。</p>
<p>自定义了心跳机制，服务器会周期性的发心跳包，客户端收到心跳后，再把心跳发给服务器，服务器和客户端以此来判断是否处于链接状态，如果服务器在连续 3 个周期没有收到心跳包的话，可以认为客户端丢失，可以断开链接。</p>
<p>5、断网重连问题：在断网后 WebSocket 也会断开，然后用了一个监听网络状态的库，如果网络重新打开了，进行重连，但也会出现 NSAssert(_readyState == SR_CONNECTING, @”Cannot call -(void)open on SRWebSocket more than once”);</p>
<p>WebSocket 记得是有重新连接的机制的。单独去监听的话，需要拿到之前那个连接，不然会出现这个错误。</p>
<p>SRWebSocket 有 didFailWithError 和 didCloseWithCode 的回调，可以在这两个回调里边进行重连。</p>
<p>6、还有一种情况，如果网络正常，服务器崩了，我应该怎么处理呢？是直接断开，还是定时重连呢？</p>
<p>服务器崩了，应该先定时重连，尝试 3 次以后就断开。这样做才比较合理，QQ 和微信都是这么做。</p>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/03/22/websocket/">http://yoursite.com/2019/03/22/websocket/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/03/22/racsignal/" class="pre"> RACSignal		</a><a href="/2019/03/22/https-e5-8d-95-e5-90-91-e8-ae-a4-e8-af-81-e5-92-8c-e5-8f-8c-e5-90-91-e8-ae-a4-e8-af-81/" class="next"> HTTPS 单向认证和双向认证		</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#一、WebSocket-的使用场景"><span class="toc-text">一、WebSocket 的使用场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#二、WebSocket-诞生由来"><span class="toc-text">二、WebSocket 诞生由来</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#三、谈谈-WebSocket-协议原理"><span class="toc-text">三、谈谈 WebSocket 协议原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#四、WebSocket-和-Socket-的区别与联系"><span class="toc-text">四、WebSocket 和 Socket 的区别与联系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#五、iOS-平台的-WebSocket-和-Socket-开源框架"><span class="toc-text">五、iOS 平台的 WebSocket 和 Socket 开源框架</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#六、iOS-平台如何实现-WebSocket-协议"><span class="toc-text">六、iOS 平台如何实现 WebSocket 协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#七、问题"><span class="toc-text">七、问题</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/13/WKWebView/">WKWebView</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/iOS 编译过程原理(2)/">iOS 编译过程原理(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/BFPRT算法/">BFPRT 算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/全排列/">全排列</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/01-背包/">0-1 背包</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/直接插入排序/">直接插入排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/armv7、armv7s、arm64/">armv7、armv7s、arm64</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/Archives配置/">Archives 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/App-Thinning/">App Thinning</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/AFNetworking/">AFNetworking</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AFNetworking/">AFNetworking</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GLSL/">GLSL</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Games/">Games</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/">Leetcode</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MJRefresh/">MJRefresh</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OC/">OC</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPENGL/">OPENGL</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactiveCocoa/">ReactiveCocoa</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SDWebImage/">SDWebImage</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpriteKit/">SpriteKit</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Xcode/">Xcode</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内存管理/">内存管理</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/减治法/">减治法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分治法/">分治法</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/动态规划/">动态规划</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/变治法/">变治法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/图像视频/">图像视频</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/多线程/">多线程</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工程发布/">工程发布</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/底层原理/">底层原理</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/性能优化/">性能优化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/排序算法/">排序算法</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/效率-工具/">效率 | 工具</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构设计/">架构设计</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法相关/">算法相关</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/视图-amp-动画/">视图 &amp; 动画</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计策略/">设计策略</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读源码/">阅读源码</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/排序算法/" style="font-size: 15px;">排序算法</a> <a href="/tags/动态规划/" style="font-size: 15px;">动态规划</a> <a href="/tags/分治法/" style="font-size: 15px;">分治法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://www.liaoxuefeng.com/" title="廖雪峰的官方网站" target="_blank">廖雪峰的官方网站</a><ul></ul><a href="https://blog.ibireme.com/" title="ibireme" target="_blank">ibireme</a><ul></ul><a href="https://www.cnblogs.com/machao/" title="马在路上" target="_blank">马在路上</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>