<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title> | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">D</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta"><a href="/2019/10/25/IT/LLVM/#comments" class="comment-count"></a><p><span class="date">Oct 25, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><hr>
<p>title: LLVM<br>categories: IT</p>
<h2 id="一、什么是-LLVM？"><a href="#一、什么是-LLVM？" class="headerlink" title="一、什么是 LLVM？"></a>一、什么是 LLVM？</h2><blockquote>
<p>The LLVM Project is a collection of modular and reusable compiler and toolchain technologies.</p>
</blockquote>
<p>简单来说，LLVM 项目是<font color="#cc0000">一系列分模块、可重用的编译工具链</font>。它提供了一种代码编写良好的中间表示(IR)，可以作为多种语言的后端，还可以提供与变成语言无关的优化和针对多种 cpu 的代码生成功能。</p>
<p>先来看下LLVM架构的主要组成部分：</p>
<ul>
<li>前端：前端用来获取源代码然后将它转变为某种中间表示，我们可以选择不同的编译器来作为LLVM的前端，如 gcc，clang。</li>
<li>Pass：通常翻译为“流程”，Pass 用来将程序的中间表示之间相互变换。一般情况下，Pass可以用来优化代码，这部分通常是我们关注的部分。</li>
<li>后端：后端用来生成实际的机器码。</li>
</ul>
<p>虽然如今大多数编译器都采用的是这种架构，但是LLVM不同的就是对于不同的语言它都提供了同一种中间表示。</p>
<p>当编译器需要支持多种源代码和目标架构时，基于LLVM的架构，设计一门新的语言只需要去实现一个新的前端就行了，支持新的后端架构也只需要实现一个新的后端就行了。其它部分完成可以复用，就不用再重新设计一次了。</p>
<h2 id="二、安装编译LLVM"><a href="#二、安装编译LLVM" class="headerlink" title="二、安装编译LLVM"></a>二、安装编译LLVM</h2><p>这里使用 clang 作为前端:</p>
<ol>
<li><p>直接从官网下载：<a href="http://releases.llvm.org/download.html" target="_blank" rel="noopener">http://releases.llvm.org/download.html</a></p>
</li>
<li><p>svn 获取</p>
 <figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">svn co <span class="symbol">http:</span>/<span class="regexp">/llvm.org/svn</span><span class="regexp">/llvm-project/llvm</span><span class="regexp">/trunk llvm</span></span><br><span class="line"><span class="regexp">cd llvm/tools</span></span><br><span class="line">svn co <span class="symbol">http:</span>/<span class="regexp">/llvm.org/svn</span><span class="regexp">/llvm-project/cfe</span><span class="regexp">/trunk clang</span></span><br><span class="line"><span class="regexp">cd ../projects</span></span><br><span class="line">svn co <span class="symbol">http:</span>/<span class="regexp">/llvm.org/svn</span><span class="regexp">/llvm-project/compiler</span>-rt/trunk compiler-rt</span><br><span class="line">cd ../tools/clang/tools</span><br><span class="line">svn co <span class="symbol">http:</span>/<span class="regexp">/llvm.org/svn</span><span class="regexp">/llvm-project/clang</span>-tools-extra/trunk extra</span><br></pre></td></tr></table></figure>
</li>
<li><p>git 获取</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> http://llvm.org/git/llvm.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> llvm/tools</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> http://llvm.org/git/clang.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../projects</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> http://llvm.org/git/compiler-rt.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../tools/clang/tools</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> http://llvm.org/git/clang-tools-extra.git</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最新的 LLVM 只支持 cmake 来编译了，首先安装 cmake。</p>
 <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span><span class="keyword">install </span>cmake</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="5">
<li><p>编译</p>
 <figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir <span class="keyword">build</span></span><br><span class="line">$ cmake /<span class="keyword">path</span>/<span class="keyword">to</span>/llvm/source</span><br><span class="line">$ cmake --<span class="keyword">build</span> .</span><br></pre></td></tr></table></figure>
<p> 编译时间比较长，而且编译结果会生成 20G 左右的文件。编译完成后，就能在 <code>build/bin/</code> 目录下面找到生成的工具了。</p>
</li>
</ol>
<h2 id="三、从源码到可执行文件"><a href="#三、从源码到可执行文件" class="headerlink" title="三、从源码到可执行文件"></a>三、从源码到可执行文件</h2><p>我们在开发的时候的时候，如果想要生成一个可执行文件或应用，我们点击 run 就完事了，那么在点击 run 之后编译器背后又做了哪些事情呢？</p>
<p>我们先来一个例子：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define TEN 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> numberOne = TEN;</span><br><span class="line">        <span class="keyword">int</span> numberTwo = <span class="number">8</span>;</span><br><span class="line">        <span class="built_in">NSString</span>* name = [[<span class="built_in">NSString</span> alloc] initWithUTF8String:<span class="string">"AloneMonkey"</span>];</span><br><span class="line">        <span class="keyword">int</span> age = numberOne + numberTwo;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Hello, %@, Age: %d"</span>, name, age);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这个文件，我们可以通过命令行直接编译，然后链接：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ xcrun -sdk iphoneos clang -arch armv7 -F Foundation -fobjc-arc -c main<span class="selector-class">.m</span> -o main.o</span><br><span class="line">$ xcrun -sdk iphoneos clang main<span class="selector-class">.o</span> -arch armv7 -fobjc-arc -framework Foundation -o main</span><br></pre></td></tr></table></figure>
<p>拷贝到手机运行：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">monkeyde-iPhone:/tmp root# ./main</span><br><span class="line"></span><br><span class="line"><span class="number">2016-12-19</span> <span class="number">17</span>:<span class="number">16:34.654</span> main[<span class="number">2164:213100</span>] Hello, AloneMonkey, Age: <span class="number">18</span></span><br></pre></td></tr></table></figure>
<p>下面继续深入剖析。</p>
<h4 id="3-1-预处理-Preprocess"><a href="#3-1-预处理-Preprocess" class="headerlink" title="3.1 预处理 Preprocess"></a>3.1 预处理 Preprocess</h4><p>这部分包括：</p>
<ol>
<li>macro 宏的展开</li>
<li>import/include 头文件的导入</li>
<li>#if 等处理。</li>
</ol>
<p>可以通过执行以下命令，来告诉 clang 只执行到预处理这一步：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>clang -E main.m</span><br></pre></td></tr></table></figure>
<p>执行完这个命令之后，我们会发现导入了很多的头文件内容。</p>
<center><br><img src="http://dzliving.com/LLVM_0.png" alt><br></center>

<p>可以看到上面的预处理已经把宏替换了，并且导入了头文件。但是这样的话会引入很多不会去改变的系统库比如 Foundation，所以有了 pch 预处理文件，可以在这里去引入一些通用的头文件。</p>
<p>后来 Xcode 新建的项目里面去掉了 pch 文件，引入了 moduels 的概念，把一些通用的库打成 modules 的形式，然后导入，默认会加上 -fmodules 参数。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>clang -E -fmodules main.m</span><br></pre></td></tr></table></figure>
<p>这样的话，只需要 @import 一下就能导入对应库的 modules 模块了。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> Foundation; </span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> numberOne = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> numberTwo = <span class="number">8</span>;</span><br><span class="line">        <span class="built_in">NSString</span>* name = [[<span class="built_in">NSString</span> alloc] initWithUTF8String:<span class="string">"AloneMonkey"</span>];</span><br><span class="line">        <span class="keyword">int</span> age = numberOne + numberTwo;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Hello, %@, Age: %d"</span>, name, age);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-词法分析-Lexical-Analysis"><a href="#3-2-词法分析-Lexical-Analysis" class="headerlink" title="3.2 词法分析 Lexical Analysis"></a>3.2 词法分析 Lexical Analysis</h4><p>在预处理之后，就要进行词法分析了，将预处理过的代码转化成一个个 Token，比如左括号、右括号、等于、字符串等等。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>clang -fmodules -fsyntax-only -Xclang -dump-tokens main.m</span><br></pre></td></tr></table></figure>
<center><br><img src="http://dzliving.com/LLVM_1.png" alt><br></center>

<h4 id="3-3-语法分析-Semantic-Analysis"><a href="#3-3-语法分析-Semantic-Analysis" class="headerlink" title="3.3 语法分析 Semantic Analysis"></a>3.3 语法分析 Semantic Analysis</h4><p>根据当前语言的语法，验证语法是否正确，并将所有节点组合成抽象语法树(AST)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">clang</span> <span class="selector-tag">-fmodules</span> <span class="selector-tag">-fsyntax-only</span> <span class="selector-tag">-Xclang</span> <span class="selector-tag">-ast-dump</span> <span class="selector-tag">main</span><span class="selector-class">.m</span></span><br></pre></td></tr></table></figure>
<center><br><img src="http://dzliving.com/LLVM_2.png" alt><br></center>

<h4 id="3-4-IR-代码生成-CodeGen"><a href="#3-4-IR-代码生成-CodeGen" class="headerlink" title="3.4 IR 代码生成 CodeGen"></a>3.4 IR 代码生成 CodeGen</h4><p>CodeGen 负责将语法树从顶至下遍历，翻译成 LLVM IR，LLVM IR 是 Frontend 的输出，也是 LLVM Backerend 的输入，桥接前后端。</p>
<p>可以在中间代码层次去做一些优化工作，我们在 Xcode 的编译设置里面也可以设置优化级别 -O1，-O3，-Os。还可以去写一些自己的 Pass，这里需要解释一下什么是 Pass。</p>
<p>Pass 就是 LLVM 系统转化和优化的工作的一个节点，每个节点做一些工作，这些工作加起来就构成了 LLVM 整个系统的优化和转化。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang -S -fobjc-arc -emit-llvm main<span class="selector-class">.m</span> -o main.ll</span><br></pre></td></tr></table></figure>
<center><br><img src="http://dzliving.com/LLVM_3.png" alt><br></center>

<h4 id="3-5-生成字节码-LLVM-Bitcode"><a href="#3-5-生成字节码-LLVM-Bitcode" class="headerlink" title="3.5 生成字节码 LLVM Bitcode"></a>3.5 生成字节码 LLVM Bitcode</h4><p>我们在 Xcode7 中默认生成 bitcode 就是这种的中间形式存在，开启了 bitcode，那么苹果后台拿到的就是这种中间代码，苹果可以对 bitcode 做一个进一步的优化，如果有新的后端架构，仍然可以用这份 bitcode 去生成。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">clang</span> <span class="selector-tag">-emit-llvm</span> <span class="selector-tag">-c</span> <span class="selector-tag">main</span><span class="selector-class">.m</span> <span class="selector-tag">-o</span> <span class="selector-tag">main</span><span class="selector-class">.bc</span></span><br></pre></td></tr></table></figure>
<center><br><img src="http://dzliving.com/LLVM_4.png" alt><br></center>

<h4 id="3-6-生成相关汇编"><a href="#3-6-生成相关汇编" class="headerlink" title="3.6 生成相关汇编"></a>3.6 生成相关汇编</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">clang</span> <span class="selector-tag">-S</span> <span class="selector-tag">-fobjc-arc</span> <span class="selector-tag">main</span><span class="selector-class">.m</span> <span class="selector-tag">-o</span> <span class="selector-tag">main</span><span class="selector-class">.s</span></span><br></pre></td></tr></table></figure>
<center><br><img src="http://dzliving.com/LLVM_5.png" alt><br></center>

<h4 id="3-7-生成目标文件"><a href="#3-7-生成目标文件" class="headerlink" title="3.7 生成目标文件"></a>3.7 生成目标文件</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">clang</span> <span class="selector-tag">-fmodules</span> <span class="selector-tag">-c</span> <span class="selector-tag">main</span><span class="selector-class">.m</span> <span class="selector-tag">-o</span> <span class="selector-tag">main</span><span class="selector-class">.o</span></span><br></pre></td></tr></table></figure>
<center><br><img src="http://dzliving.com/LLVM_6.png" alt><br></center>

<h4 id="3-8-生成可执行文件"><a href="#3-8-生成可执行文件" class="headerlink" title="3.8 生成可执行文件"></a>3.8 生成可执行文件</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang main<span class="selector-class">.o</span> -o main</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<center><br><img src="http://dzliving.com/LLVM_7.png" alt><br></center>


<h2 id="四、可以用-Clang-做什么？"><a href="#四、可以用-Clang-做什么？" class="headerlink" title="四、可以用 Clang 做什么？"></a>四、可以用 Clang 做什么？</h2><h4 id="4-1-libclang-进行语法分析"><a href="#4-1-libclang-进行语法分析" class="headerlink" title="4.1 libclang 进行语法分析"></a>4.1 libclang 进行语法分析</h4><p>可以使用 libclang 里面提供的方法对源文件进行语法分析，分析它的语法树，遍历语法树上面的每一个节点。可以用于检查拼写错误，或者做字符串加密。</p>
<p>来看一段代码的使用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * hand = dlopen(<span class="string">"/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/libclang.dylib"</span>,RTLD_LAZY);</span><br><span class="line">        </span><br><span class="line"><span class="comment">//初始化函数指针</span></span><br><span class="line">initlibfunclist(hand);</span><br><span class="line"></span><br><span class="line">CXIndex cxindex = myclang_createIndex(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *filename = <span class="string">"/path/to/filename"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> ** new_command = malloc(<span class="number">10240</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableString</span> *mus = [<span class="built_in">NSMutableString</span> stringWithString:<span class="string">@"/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -x objective-c -arch armv7 -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk"</span>]; </span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *arr = [mus componentsSeparatedByString:<span class="string">@" "</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *tmp <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    new_command[index++] = [tmp UTF8String];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nameArr = [[<span class="built_in">NSMutableArray</span> alloc] initWithCapacity:<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">TU = myclang_parseTranslationUnit(cxindex, filename, new_command, index, <span class="literal">NULL</span>, <span class="number">0</span>, myclang_defaultEditingTranslationUnitOptions());</span><br><span class="line"></span><br><span class="line">CXCursor rootCursor = myclang_getTranslationUnitCursor(TU);</span><br><span class="line"></span><br><span class="line">myclang_visitChildren(rootCursor, printVisitor, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">myclang_disposeTranslationUnit(TU);</span><br><span class="line">myclang_disposeIndex(cxindex);</span><br><span class="line">free(new_command);</span><br><span class="line"></span><br><span class="line">dlclose(hand);</span><br></pre></td></tr></table></figure>
<p>然后我们就可以在 <code>printVisitor</code> 这个函数里面去遍历输入文件的语法树了。</p>
<p>我们也通过 python 去调用用 clang：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip <span class="keyword">install</span> clang</span><br></pre></td></tr></table></figure>
<p>那么基于语法树的分析，我们可以针对字符串做加密。</p>
<h4 id="4-2-LibTooling"><a href="#4-2-LibTooling" class="headerlink" title="4.2 LibTooling"></a>4.2 LibTooling</h4><p>对语法树有完全的控制权，可以作为一个单独的命令使用，如：clang-format</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang-<span class="keyword">format</span> main.<span class="built_in">m</span></span><br></pre></td></tr></table></figure>
<p>我们也可以自己写一个这样的工具去遍历、访问、甚至修改语法树。 目录:llvm/tools/clang/tools</p>
<p>上面的代码通过遍历语法树，去修改里面的方法名和返回变量名：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">before:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_math</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</span><br><span class="line">    *x += <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">-1</span>, val = <span class="number">4</span>;</span><br><span class="line">    do_math(&amp;val);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">after:</span><br><span class="line">** Rewrote function def: do_math</span><br><span class="line">** Rewrote function call</span><br><span class="line">** Rewrote ReturnStmt</span><br><span class="line"></span><br><span class="line">Found <span class="number">2</span> functions.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add5</span><span class="params">(<span class="keyword">int</span> *x)</span> </span>&#123;</span><br><span class="line">    *x += <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">-1</span>, val = <span class="number">4</span>;</span><br><span class="line">    add5(&amp;val);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，我们看到 LibTooling 对代码的语法树有完全的控制，那么我们可以基于它去检查命名的规范，甚至做一个代码的转换，比如实现 OC 转 Swift。</p>
<h4 id="4-3-ClangPlugin"><a href="#4-3-ClangPlugin" class="headerlink" title="4.3 ClangPlugin"></a>4.3 ClangPlugin</h4><p>对语法树有完全的控制权，作为插件注入到编译流程中，可以影响 build 和决定编译过程。目录:llvm/tools/clang/examples</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/Driver/Options.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/AST/AST.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/AST/ASTContext.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/AST/ASTConsumer.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/AST/RecursiveASTVisitor.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/Frontend/ASTConsumers.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/Frontend/FrontendActions.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/Frontend/CompilerInstance.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/Frontend/FrontendPluginRegistry.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clang/Rewrite/Core/Rewriter.h"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> clang;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line">Rewriter rewriter;</span><br><span class="line"><span class="keyword">int</span> numFunctions = <span class="number">0</span>;</span><br><span class="line">class ExampleVisitor : <span class="keyword">public</span> RecursiveASTVisitor&lt;ExampleVisitor&gt; &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ASTContext *astContext; <span class="comment">// used for getting additional AST info</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">explicit</span> ExampleVisitor(CompilerInstance *CI) </span><br><span class="line">      : astContext(&amp;(CI-&gt;getASTContext())) <span class="comment">// initialize private members</span></span><br><span class="line">    &#123;</span><br><span class="line">        rewriter.setSourceMgr(astContext-&gt;getSourceManager(), astContext-&gt;getLangOpts());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">bool</span> VisitFunctionDecl(FunctionDecl *func) &#123;</span><br><span class="line">        numFunctions++;</span><br><span class="line">        <span class="keyword">string</span> funcName = func-&gt;getNameInfo().getName().getAsString();</span><br><span class="line">        <span class="built_in">if</span> (funcName == <span class="string">"do_math"</span>) &#123;</span><br><span class="line">            rewriter.ReplaceText(func-&gt;getLocation(), funcName.length(), <span class="string">"add5"</span>);</span><br><span class="line">            errs() &lt;&lt; <span class="string">"** Rewrote function def: "</span> &lt;&lt; funcName &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="built_in">return</span> true;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">bool</span> VisitStmt(Stmt *st) &#123;</span><br><span class="line">        <span class="built_in">if</span> (ReturnStmt *ret = dyn_cast&lt;ReturnStmt&gt;(st)) &#123;</span><br><span class="line">            rewriter.ReplaceText(ret-&gt;getRetValue()-&gt;getLocStart(), <span class="number">6</span>, <span class="string">"val"</span>);</span><br><span class="line">            errs() &lt;&lt; <span class="string">"** Rewrote ReturnStmt\n"</span>;</span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="built_in">if</span> (CallExpr *call = dyn_cast&lt;CallExpr&gt;(st)) &#123;</span><br><span class="line">            rewriter.ReplaceText(call-&gt;getLocStart(), <span class="number">7</span>, <span class="string">"add5"</span>);</span><br><span class="line">            errs() &lt;&lt; <span class="string">"** Rewrote function call\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">class ExampleASTConsumer : <span class="keyword">public</span> ASTConsumer &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ExampleVisitor *visitor; <span class="comment">// doesn't have to be private</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// override the constructor in order to pass CI</span></span><br><span class="line">    <span class="keyword">explicit</span> ExampleASTConsumer(CompilerInstance *CI):</span><br><span class="line">        visitor(<span class="keyword">new</span> ExampleVisitor(CI)) &#123; &#125; <span class="comment">// initialize the visitor</span></span><br><span class="line">    <span class="comment">// override this to call our ExampleVisitor on the entire source file</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">void</span> HandleTranslationUnit(ASTContext &amp;Context) &#123;</span><br><span class="line">        <span class="comment">/* we can use ASTContext to get the TranslationUnitDecl, which is</span></span><br><span class="line"><span class="comment">             a single Decl that collectively represents the entire source file */</span></span><br><span class="line">        visitor-&gt;TraverseDecl(Context.getTranslationUnitDecl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">class PluginExampleAction : <span class="keyword">public</span> PluginASTAction &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// this gets called by Clang when it invokes our Plugin</span></span><br><span class="line">    <span class="comment">// Note that unique pointer is used here.</span></span><br><span class="line">    std::unique_ptr&lt;ASTConsumer&gt; CreateASTConsumer(CompilerInstance &amp;CI, StringRef file) &#123;</span><br><span class="line">        <span class="built_in">return</span> llvm::make_unique&lt;ExampleASTConsumer&gt;(&amp;CI);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// implement this function if you want to parse custom cmd-line args</span></span><br><span class="line">    <span class="keyword">bool</span> ParseArgs(<span class="keyword">const</span> CompilerInstance &amp;CI, <span class="keyword">const</span> vector&lt;<span class="keyword">string</span>&gt; &amp;args) &#123;</span><br><span class="line">        <span class="built_in">return</span> true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> FrontendPluginRegistry::Add&lt;PluginExampleAction&gt; X(<span class="string">"-example-plugin"</span>, <span class="string">"simple Plugin example"</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clang -Xclang -load -Xclang ../build/<span class="class"><span class="keyword">lib</span>/<span class="title">PluginExample</span>.<span class="title">dylib</span> -<span class="title">Xclang</span> -<span class="title">plugin</span> -<span class="title">Xclang</span> -<span class="title">example</span>-<span class="title">plugin</span> -<span class="title">c</span> <span class="title">testPlugin</span>.<span class="title">c</span></span></span><br><span class="line">** Rewrote function <span class="function"><span class="keyword">def</span>: <span class="title">do_math</span></span></span><br><span class="line">** Rewrote function call</span><br><span class="line">** Rewrote ReturnStmt</span><br></pre></td></tr></table></figure>
<p>我们可以基于 ClangPlugin 做些什么事情呢？我们可以用来定义一些编码规范，比如代码风格检查，命名检查等等。下面是我写的判断类名前两个字母是不是大写的例子，如果不是报错。(当然这只是一个例子而已。。。)</p>
<h2 id="五、动手写-Pass"><a href="#五、动手写-Pass" class="headerlink" title="五、动手写 Pass"></a>五、动手写 Pass</h2><h4 id="5-1-一个简单的-Pass"><a href="#5-1-一个简单的-Pass" class="headerlink" title="5.1 一个简单的 Pass"></a>5.1 一个简单的 Pass</h4><p>前面我们说到，Pass 就是 LLVM 系统转化和优化的工作的一个节点，当然我们也可以写一个这样的节点去做一些自己的优化工作或者其它的操作。下面我们来看一下一个简单 Pass 的编写流程：</p>
<ol>
<li><p>创建头文件</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> llvm/include/llvm/Transforms/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir Obfuscation</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> Obfuscation</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> touch SimplePass.h</span></span><br></pre></td></tr></table></figure>
<p> 写入内容：</p>
 <figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/IR/Function.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/Pass.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/Support/raw_ostream.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/IR/Intrinsics.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/IR/Instructions.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/IR/LegacyPassManager.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/Transforms/IPO/PassManagerBuilder.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Namespace</span></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">namespace <span class="class">llvm </span>&#123;</span><br><span class="line">	Pass *createSimplePass(bool flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建源文件</p>
 <figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cd llvm/<span class="class"><span class="keyword">lib</span>/<span class="title">Transforms</span>/</span></span><br><span class="line">$ mkdir Obfuscation</span><br><span class="line">$ cd Obfuscation</span><br><span class="line"></span><br><span class="line">$ touch CMakeLists.txt</span><br><span class="line">$ touch LLVMBuild.txt</span><br><span class="line">$ touch SimplePass.cpp</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>CMakeLists.txt:

<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add_llvm_loadable_module(<span class="name">LLVMObfuscation</span></span><br><span class="line">  SimplePass.cpp</span><br><span class="line">  </span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  add_dependencies(<span class="name">LLVMObfuscation</span> intrinsics_gen)</span><br></pre></td></tr></table></figure>

LLVMBuild.txt:

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[component_0]</span><br><span class="line">type = Library</span><br><span class="line">name = Obfuscation</span><br><span class="line">parent = Transforms</span><br><span class="line">library_name = Obfuscation</span><br></pre></td></tr></table></figure>

SimplePass.cpp:

<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include "llvm/Transforms/Obfuscation/SimplePass.h"</span></span><br><span class="line">using <span class="keyword">namespace</span> <span class="title">llvm</span>;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">struct</span> <span class="title">SimplePass</span> : <span class="title">public</span> <span class="title">FunctionPass</span> &#123;</span><br><span class="line">        <span class="title">static</span> <span class="title">char</span> <span class="title">ID</span>; <span class="comment">// Pass identification, replacement for typeid</span></span><br><span class="line">        <span class="keyword">bool</span> flag;</span><br><span class="line">         </span><br><span class="line">        SimplePass() : FunctionPass(ID) &#123;&#125;</span><br><span class="line">        SimplePass(<span class="keyword">bool</span> flag) : FunctionPass(ID) &#123;</span><br><span class="line">        	this-&gt;flag = flag;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">bool</span> runOnFunction(<span class="function"><span class="keyword">Function</span> &amp;<span class="title">F</span>) <span class="title">override</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">if</span>(this-&gt;flag)&#123;</span><br><span class="line">                <span class="function"><span class="keyword">Function</span> *<span class="title">tmp</span> = &amp;<span class="title">F</span></span>;</span><br><span class="line">                <span class="comment">// 遍历函数中的所有基本块</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="function"><span class="keyword">Function</span>::<span class="title">iterator</span> <span class="title">bb</span> = <span class="title">tmp</span>-&gt;<span class="title">begin</span><span class="params">()</span></span>; bb != tmp-&gt;end(); ++bb) &#123;</span><br><span class="line">                    <span class="comment">// 遍历基本块中的每条指令</span></span><br><span class="line">                    <span class="keyword">for</span> (BasicBlock::iterator inst = bb-&gt;begin(); inst != bb-&gt;end(); ++inst) &#123;</span><br><span class="line">                        <span class="comment">// 是否是add指令</span></span><br><span class="line">                        <span class="keyword">if</span> (inst-&gt;isBinaryOp()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (inst-&gt;getOpcode() == Instruction::Add) &#123;</span><br><span class="line">                                ob_add(cast&lt;BinaryOperator&gt;(inst));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// a+b === a-(-b)</span></span><br><span class="line">        void ob_add(BinaryOperator *bo) &#123;</span><br><span class="line">            BinaryOperator *op = <span class="keyword">NULL</span>;</span><br><span class="line">             </span><br><span class="line">            <span class="keyword">if</span> (bo-&gt;getOpcode() == Instruction::Add) &#123;</span><br><span class="line">                <span class="comment">// 生成 (－b)</span></span><br><span class="line">                op = BinaryOperator::CreateNeg(bo-&gt;getOperand(<span class="number">1</span>), <span class="string">""</span>, bo);</span><br><span class="line">                <span class="comment">// 生成 a-(-b)</span></span><br><span class="line">                op = BinaryOperator::Create(Instruction::Sub, bo-&gt;getOperand(<span class="number">0</span>), op, <span class="string">""</span>, bo);</span><br><span class="line">                 </span><br><span class="line">                op-&gt;setHasNoSignedWrap(bo-&gt;hasNoSignedWrap());</span><br><span class="line">                op-&gt;setHasNoUnsignedWrap(bo-&gt;hasNoUnsignedWrap());</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            <span class="comment">// 替换所有出现该指令的地方</span></span><br><span class="line">            bo-&gt;replaceAllUsesWith(op);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">char</span> SimplePass::ID = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 注册pass 命令行选项显示为simplepass</span></span><br><span class="line"><span class="keyword">static</span> RegisterPass&lt;SimplePass&gt; X(<span class="string">"simplepass"</span>, <span class="string">"this is a Simple Pass"</span>);</span><br><span class="line">Pass *llvm::createSimplePass() &#123; <span class="keyword">return</span> <span class="keyword">new</span> SimplePass(); &#125;</span><br></pre></td></tr></table></figure>

修改 `.../Transforms/LLVMBuild.txt`，加上刚刚写的模块 `Obfuscation`

<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">subdirectories </span>= Coroutines IPO <span class="keyword">InstCombine </span><span class="keyword">Instrumentation </span><span class="keyword">Scalar </span>Utils Vectorize ObjCARC Obfuscation</span><br></pre></td></tr></table></figure>

修改 `.../Transforms/CMakeLists.txt`，加上刚刚写的模块 `Obfuscation`

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(Obfuscation)</span></span></span><br></pre></td></tr></table></figure>

编译生成：`LLVMSimplePass.dylib`

因为 Pass 是作用于中间代码，所以我们首先要生成一份中间代码：

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -emit-llvm -c <span class="keyword">test</span>.c -o <span class="keyword">test</span>.bc</span><br></pre></td></tr></table></figure>


然后加载 Pass 优化：

<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../build/bin/opt -load ../build/<span class="class"><span class="keyword">lib</span>/<span class="title">LLVMSimplePass</span>.<span class="title">dylib</span> -<span class="title">test</span> &lt; <span class="title">test</span>.<span class="title">bc</span> &gt; <span class="title">after_test</span>.<span class="title">bc</span></span></span><br></pre></td></tr></table></figure>


对比中间代码：

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">llvm-dis test<span class="selector-class">.bc</span> -o test.ll</span><br><span class="line">llvm-dis after_test<span class="selector-class">.bc</span> -o after_test.ll</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">test.ll</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">entry:</span><br><span class="line">  %retval = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  %a = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  %b = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  %c = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  store i32 0, i32* %retval,<span class="built_in"> align </span>4</span><br><span class="line">  store i32 3, i32* %a,<span class="built_in"> align </span>4</span><br><span class="line">  store i32 4, i32* %b,<span class="built_in"> align </span>4</span><br><span class="line">  %0 = load i32, i32* %a,<span class="built_in"> align </span>4</span><br><span class="line">  %1 = load i32, i32* %b,<span class="built_in"> align </span>4</span><br><span class="line">  %<span class="builtin-name">add</span> = <span class="builtin-name">add</span> nsw i32 %0, %1</span><br><span class="line">  store i32 %add, i32* %c,<span class="built_in"> align </span>4</span><br><span class="line">  %2 = load i32, i32* %c,<span class="built_in"> align </span>4</span><br><span class="line">  %call = call i32 (i8*, <span class="built_in">..</span>.) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i32 %2)</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">after_test.ll</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">entry:</span><br><span class="line">  %retval = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  %a = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  %b = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  %c = alloca i32,<span class="built_in"> align </span>4</span><br><span class="line">  store i32 0, i32* %retval,<span class="built_in"> align </span>4</span><br><span class="line">  store i32 3, i32* %a,<span class="built_in"> align </span>4</span><br><span class="line">  store i32 4, i32* %b,<span class="built_in"> align </span>4</span><br><span class="line">  %0 = load i32, i32* %a,<span class="built_in"> align </span>4</span><br><span class="line">  %1 = load i32, i32* %b,<span class="built_in"> align </span>4</span><br><span class="line">  %2 = sub i32 0, %1</span><br><span class="line">  %3 = sub nsw i32 %0, %2</span><br><span class="line">  %<span class="builtin-name">add</span> = <span class="builtin-name">add</span> nsw i32 %0, %1</span><br><span class="line">  store i32 %3, i32* %c,<span class="built_in"> align </span>4</span><br><span class="line">  %4 = load i32, i32* %c,<span class="built_in"> align </span>4</span><br><span class="line">  %call = call i32 (i8*, <span class="built_in">..</span>.) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i32 %4)</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br></pre></td></tr></table></figure>

这里写的 Pass 只是把 a+b 简单的替换成了 a-(-b)，只是一个演示，怎么去写自己的 Pass，并且作用于代码。
</code></pre><h4 id="5-2-将-Pass-加入-PassManager-管理"><a href="#5-2-将-Pass-加入-PassManager-管理" class="headerlink" title="5.2 将 Pass 加入 PassManager 管理"></a>5.2 将 Pass 加入 PassManager 管理</h4><p>上面我们是单独去加载 Pass 动态库，这里我们将 Pass 加入 PassManager，这样我们就可以直接通过 clang 的参数去加载我们的 Pass 了。</p>
<p>首先在 <code>llvm/lib/Transforms/IPO/PassManagerBuilder.cpp</code> 添加头文件。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"llvm/Transforms/Obfuscation/SimplePass.h"</span></span></span><br></pre></td></tr></table></figure>
<p>然后添加如下语句：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> cl::opt&lt;<span class="built_in">bool</span>&gt; SimplePass(<span class="string">"simplepass"</span>, cl::init(<span class="literal">false</span>),</span><br><span class="line">                           cl::desc(<span class="string">"Enable simple pass"</span>));</span><br></pre></td></tr></table></figure>
<p>然后在 <code>populateModulePassManager</code> 这个函数中添加如下代码：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MPM.<span class="builtin-name">add</span>(createSimplePass(SimplePass));</span><br></pre></td></tr></table></figure>
<p>最后在 IPO 这个目录的 <code>LLVMBuild.txt</code> 中添加库的支持，否则在编译的时候会提示链接错误。具体内容如下：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">required_libraries = Analysis Core InstCombine IRReader Linker Object ProfileData <span class="keyword">Scalar</span> Support <span class="comment">TransformUtils Vectorize Obfuscation</span></span><br></pre></td></tr></table></figure>
<p>修改 Pass 的 CMakeLists.txt 为静态库形式：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add_llvm_library(LLVMObfuscation</span><br><span class="line">  SimplePass.cpp</span><br><span class="line">  )</span><br><span class="line"><span class="function"><span class="title">add_dependencies</span><span class="params">(LLVMObfuscation intrinsics_gen)</span></span></span><br></pre></td></tr></table></figure>
<p>最后再编译一次。</p>
<p>那么我们可以这么去调用：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../build/bin/clang -mllvm -simplepass test<span class="selector-class">.c</span> -o after_test</span><br></pre></td></tr></table></figure>
<p>基于 Pass，我们可以做什么？我们可以编写自己的 Pass 去混淆代码，以增加他人反编译的难度。</p>
<p>我们可以把代码左上角的样子，变成右下角的样子，甚至更加复杂~</p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ol>
<li><p>LLVM 编译一个源文件的过程：</p>
 <center><br> 预处理<br><br> ↓<br><br> 词法分析<br><br> ↓<br><br> Token<br><br> ↓<br><br> 语法分析<br><br> ↓<br><br> AST<br><br> ↓<br><br> 代码生成<br><br> ↓<br><br> LLVM IR<br><br> ↓<br><br> 优化<br><br> ↓<br><br> 生成汇编代码<br><br> ↓<br><br> Link<br><br> ↓<br><br> 目标文件<br> </center>
</li>
<li><p>基于LLVM，我们可以做什么？</p>
<ul>
<li>做语法树分析，实现语言转换：OC 转 Swift、JS or 其它语言</li>
<li>字符串加密</li>
<li>编写 ClangPlugin，命名规范，代码规范，扩展功能。</li>
<li>编写 Pass，代码混淆优化。</li>
</ul>
</li>
</ol>
<h2 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h2><p><a href="https://neyoufan.github.io/2016/12/29/ios/%E5%85%B3%E4%BA%8ELLVM%E8%BF%99%E4%BA%9B%E4%B8%9C%E8%A5%BF%E4%BD%A0%E5%BF%85%E9%A1%BB%E8%A6%81%E7%9F%A5%E9%81%93%20/" target="_blank" rel="noopener">关于LLVM，这些东西你必须要知道</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/10/25/IT/LLVM/">http://yoursite.com/2019/10/25/IT/LLVM/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/10/25/iOS/iOS原理/Autorelease/" class="pre">Autorelease</a><a href="/2019/10/25/IT/Clang/" class="next">clang</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、什么是-LLVM？"><span class="toc-text">一、什么是 LLVM？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、安装编译LLVM"><span class="toc-text">二、安装编译LLVM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、从源码到可执行文件"><span class="toc-text">三、从源码到可执行文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-预处理-Preprocess"><span class="toc-text">3.1 预处理 Preprocess</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-词法分析-Lexical-Analysis"><span class="toc-text">3.2 词法分析 Lexical Analysis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-语法分析-Semantic-Analysis"><span class="toc-text">3.3 语法分析 Semantic Analysis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-IR-代码生成-CodeGen"><span class="toc-text">3.4 IR 代码生成 CodeGen</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-生成字节码-LLVM-Bitcode"><span class="toc-text">3.5 生成字节码 LLVM Bitcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-生成相关汇编"><span class="toc-text">3.6 生成相关汇编</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-生成目标文件"><span class="toc-text">3.7 生成目标文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8-生成可执行文件"><span class="toc-text">3.8 生成可执行文件</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#四、可以用-Clang-做什么？"><span class="toc-text">四、可以用 Clang 做什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-libclang-进行语法分析"><span class="toc-text">4.1 libclang 进行语法分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-LibTooling"><span class="toc-text">4.2 LibTooling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-ClangPlugin"><span class="toc-text">4.3 ClangPlugin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、动手写-Pass"><span class="toc-text">五、动手写 Pass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-一个简单的-Pass"><span class="toc-text">5.1 一个简单的 Pass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-将-Pass-加入-PassManager-管理"><span class="toc-text">5.2 将 Pass 加入 PassManager 管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、总结"><span class="toc-text">六、总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文章"><span class="toc-text">文章</span></a></li></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS原理/iOS UmbrellaFramework/">iOS UmbrellaFramework</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS原理/iOS UmbrellaHeader/">iOS umbrella header</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS媒体/iOS 图片/">iOS 图片</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/05/iOS/iOS优化/iOS 优化实例/">iOS 优化实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/05/iOS/iOS原理/iOS 操作系统架构/">iOS 操作系统架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS架构/iOS 网络层设计/">iOS网络层设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS 类簇/">iOS 类簇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS OCR/">iOS OCR</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS IM/">iOS IM</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/30/iOS/iOS原理/iOS 推送/">iOS 推送</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GLSL/">GLSL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IT/">IT</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL/">OpenGL</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS优化/">iOS优化</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS动画/">iOS动画</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS原理/">iOS原理</a><span class="category-list-count">42</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS多线程/">iOS多线程</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS媒体/">iOS媒体</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS安全/">iOS安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS架构/">iOS架构</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">5</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p> 
京ICP备 - <a target="_blank" href="http://www.beian.miit.gov.cn">19039713号</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>