<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>iOS 编译过程原理(1) | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS 编译过程原理(1)</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">iOS 编译过程原理(1)</h1><div class="post-meta"><a href="/2019/09/10/iOS/iOS原理/iOS 编译过程原理(1)/#comments" class="comment-count"></a><p><span class="date">Sep 10, 2019</span><span><a href="/categories/iOS原理/" class="category">iOS原理</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>一般可以将编程语言分为两种，<a href="https://zh.wikipedia.org/wiki/%E7%B7%A8%E8%AD%AF%E8%AA%9E%E8%A8%80" target="_blank" rel="noopener">编译语言</a>和<a href="https://en.wikipedia.org/wiki/Interpreted_language" target="_blank" rel="noopener">直译式语言</a>。</p>
<p>像 C++、Objective-C 都是编译语言。编译语言在执行的时候，必须<font color="#cc0000">先通过编译器生成机器码</font>，机器码可以直接在 CPU 上执行，所以执行效率较高。</p>
<p>像 JavaScript、Python 都是直译式语言。直译式语言不需要经过编译的过程，而是<font color="#cc0000">在执行的时候通过一个中间的解释器将代码解释为 CPU 可以执行的代码</font>。所以，较编译语言来说，直译式语言效率低一些，但是编写的更灵活。</p>
<p>iOS 开发目前的常用语言：Objective-C 和 Swift。二者都是编译语言，换句话说都是需要编译才能执行的。它们的编译都是依赖于 Clang(swift) + LLVM。本文只关注 Objective-C，原理上大同小异。</p>
<p>充分理解了编译的过程，会对你的开发大有帮助。本文的最后，会以以下几个例子，来讲解如何合理利用 XCode 和编译</p>
<ul>
<li>__attribute__</li>
<li>Clang 警告处理</li>
<li>预处理</li>
<li>插入编译期脚本</li>
<li>提高项目编译速度</li>
</ul>
<h2 id="二、iOS-编译"><a href="#二、iOS-编译" class="headerlink" title="二、iOS 编译"></a>二、iOS 编译</h2><p>Objective-C 采用 Clang 作为前端，而 Swift 则采用 swift() 作为前端，都是 LLVM（Low level vritual machine）作为编译器后端。所以简单的编译过程如图：</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-3a4fe4a482e93bda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1"><br></center>

<p>其中，swift 的编译命令可以在这里找到</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>Developer<span class="regexp">/Toolchains/</span>XcodeDefault.xctoolchain<span class="regexp">/usr/</span>bin<span class="regexp">/swift</span></span><br></pre></td></tr></table></figure>
<p>可以通过 Clang，来<font color="#cc0000">查看一个文件的编译具体过程</font>，新建 Demo.m</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,<span class="string">@"Hello Leo"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后终端输入：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~ $ cd /Users/dubin/Desktop/Demo/Demo</span><br><span class="line">Demo $ </span><br><span class="line">Demo $ clang -ccc-print-phases -framework Foundation Demo<span class="selector-class">.m</span> -o Demo </span><br><span class="line"><span class="number">0</span>: <span class="selector-tag">input</span>, <span class="string">"Foundation"</span>, object</span><br><span class="line"><span class="number">1</span>: <span class="selector-tag">input</span>, <span class="string">"Demo.m"</span>, objective-c</span><br><span class="line"><span class="number">2</span>: preprocessor, &#123;<span class="number">1</span>&#125;, objective-c-cpp-output  <span class="comment">// 预处理</span></span><br><span class="line"><span class="number">3</span>: compiler, &#123;<span class="number">2</span>&#125;, ir                          <span class="comment">// 编译生成 IR（中间代码）</span></span><br><span class="line"><span class="number">4</span>: backend, &#123;<span class="number">3</span>&#125;, assembler                    <span class="comment">// 汇编器生成汇编代码</span></span><br><span class="line"><span class="number">5</span>: assembler, &#123;<span class="number">4</span>&#125;, <span class="selector-tag">object</span>                     <span class="comment">// 生成机器码</span></span><br><span class="line"><span class="number">6</span>: linker, &#123;<span class="number">0</span>, <span class="number">5</span>&#125;, image                      <span class="comment">// 链接</span></span><br><span class="line"><span class="number">7</span>: bind-arch, <span class="string">"x86_64"</span>, &#123;<span class="number">6</span>&#125;, image            <span class="comment">// 生成 Image，也就是最后的可执行文件</span></span><br></pre></td></tr></table></figure>
<p>在终端运行这个程序：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Demo $ gcc -framework Foundation Demo.m -o Demo</span><br><span class="line">$ ./Demo</span><br><span class="line"><span class="number">2019-03-27</span> <span class="number">13</span>:<span class="number">55:30.426</span> Demo[<span class="number">14155</span>:<span class="number">5478670</span>] Hello Leo</span><br></pre></td></tr></table></figure>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-9a33d4c189414790.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2"><br></center>

<p>另一种终端运行 OC 程序的顺序：</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Demo $ cc -c Demo.m</span><br><span class="line">Demo $ cc Demo.o -framework Foundation</span><br><span class="line">ld: <span class="literal">warning</span>: <span class="literal">text</span>-based stub <span class="keyword">file</span> /System/<span class="keyword">Library</span>/Frameworks//Foundation.framework/Foundation.tbd <span class="keyword">and</span> <span class="keyword">library</span> <span class="keyword">file</span> /System/<span class="keyword">Library</span>/Frameworks//Foundation.framework/Foundation are <span class="keyword">out</span> <span class="keyword">of</span> sync. Falling back <span class="keyword">to</span> <span class="keyword">library</span> <span class="keyword">file</span> <span class="keyword">for</span> linking.</span><br><span class="line">ld: <span class="literal">warning</span>: <span class="literal">text</span>-based stub <span class="keyword">file</span> /System/<span class="keyword">Library</span>/Frameworks//CoreFoundation.framework/Versions/A/CoreFoundation.tbd <span class="keyword">and</span> <span class="keyword">library</span> <span class="keyword">file</span> /System/<span class="keyword">Library</span>/Frameworks//CoreFoundation.framework/Versions/A/CoreFoundation are <span class="keyword">out</span> <span class="keyword">of</span> sync. Falling back <span class="keyword">to</span> <span class="keyword">library</span> <span class="keyword">file</span> <span class="keyword">for</span> linking.</span><br><span class="line">Demo $ ./a.<span class="keyword">out</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">27</span> <span class="number">14</span>:<span class="number">01</span>:<span class="number">52.933</span> a.<span class="keyword">out</span>[<span class="number">14413</span>:<span class="number">5483194</span>] Hello Leo</span><br></pre></td></tr></table></figure>
<p>cc -c tst.m    编译：生成 tst.o文件</p>
<p>cc -c man.m        编译： 生成 man.o 文件</p>
<p>cc tst.o man.o -framework Foundation  链接、合并：生成 a.out 可执行文件</p>
<p>./a.out 运行</p>
<p>当然 OC 程序还可以混编 C 程序，格式为：cc -c x.m x.c，或者直接将编译和链接合在一起：cc x.m x.c</p>
<ol>
<li><p>编译器前端</p>
<p> 编译器前端的任务是：语法分析、语义分析、生成中间代码（intermediate representation）。在这个过程中<font color="#cc0000">会进行类型检查，如果发现错误或者警告会标注出来在哪一行</font>。</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-eba0d4d3a3fbec8e?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3"><br> </center>
</li>
<li><p>编译器后端</p>
<p> 编译器后端会进行机器无关的代码优化，生成机器语言，并且进行机器相关的代码优化。iOS 的编译过程，后端的处理如下</p>
<p> ①、LVVM 优化器会进行 BitCode 的生成，链接期优化等等。</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/5294842-7fc3096f9cf495e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4"></p>
<p> ②、LLVM 机器码生成器会针对不同的架构，比如 arm64 等生成不同的机器码。</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/5294842-2037b2a6480b4d2f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5"></p>
</li>
</ol>
<h2 id="三、执行一次-XCode-build-的流程"><a href="#三、执行一次-XCode-build-的流程" class="headerlink" title="三、执行一次 XCode build 的流程"></a>三、执行一次 XCode build 的流程</h2><p>当你在 XCode 中，选择 build 的时候（快捷键 command+B），会执行如下过程</p>
<ul>
<li>编译信息写入辅助文件，创建编译后的文件架构（name.app）</li>
<li>处理文件打包信息，例如在 debug 环境下</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Entitlements:</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"application-identifier"</span> = <span class="string">"app的bundleid"</span><span class="comment">;</span></span><br><span class="line">    <span class="string">"aps-environment"</span> = development<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行 CocoaPod 编译前脚本。例如对于使用 CocoaPod 的工程会执行 <font color="#cc0000">CheckPods Manifest.lock</font></li>
<li>编译各个 .m 文件，使用 <font color="#cc0000">CompileC</font> 和 <font color="#cc0000">clang</font> 命令。</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CompileC ClassName.o ClassName.m normal x86_64 objective-c com.apple.compilers.llvm.clang.1_0.compiler</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">LANG</span>=en_US.US-ASCII</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="string">"..."</span></span><br><span class="line">clang -x objective-c -arch x86_64 <span class="attribute">-fmessage-length</span>=0 -fobjc-arc<span class="built_in">..</span>. -Wno-missing-field-initializers <span class="built_in">..</span>. <span class="attribute">-DDEBUG</span>=1 <span class="built_in">..</span>. -isysroot iPhoneSimulator10.1.sdk -fasm-blocks <span class="built_in">..</span>. -I 上文提到的文件 -F 所需要的Framework  -iquote 所需要的Framework  <span class="built_in">..</span>. -c ClassName.c -o ClassName.o</span><br></pre></td></tr></table></figure>
<p>通过这个编译的命令，我们可以看到</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">clang是实际的编译命令</span><br><span class="line"><span class="deletion">-x 		objective-c 指定了编译的语言</span></span><br><span class="line"><span class="deletion">-arch 	x86_64制定了编译的架构，类似还有arm7等</span></span><br><span class="line"><span class="deletion">-fobjc-arc 一些列-f开头的，指定了采用arc等信息。这个也就是为什么你可以对单独的一个.m文件采用非ARC编程。</span></span><br><span class="line"><span class="deletion">-Wno-missing-field-initializers 一系列以-W开头的，指的是编译的警告选项，通过这些你可以定制化编译选项</span></span><br><span class="line"><span class="deletion">-DDEBUG=1 一些列-D开头的，指的是预编译宏，通过这些宏可以实现条件编译</span></span><br><span class="line"><span class="deletion">-iPhoneSimulator10.1.sdk 制定了编译采用的iOS SDK版本</span></span><br><span class="line"><span class="deletion">-I 把编译信息写入指定的辅助文件</span></span><br><span class="line"><span class="deletion">-F 链接所需要的Framework</span></span><br><span class="line"><span class="deletion">-c ClassName.c 编译文件</span></span><br><span class="line"><span class="deletion">-o ClassName.o 编译产物</span></span><br></pre></td></tr></table></figure>
<ul>
<li>链接需要的 Framework，例如 Foundation.framework、AFNetworking.framework、AliPay.framework</li>
<li>编译 xib 文件</li>
<li>拷贝 xib，图片等资源文件到结果目录</li>
<li>编译 ImageAssets</li>
<li>处理 info.plist</li>
<li>执行 CocoaPod 脚本</li>
<li>拷贝 Swift 标准库</li>
<li>创建 .app 文件和对其签名</li>
</ul>
<h2 id="四、ipa-包的内容"><a href="#四、ipa-包的内容" class="headerlink" title="四、ipa 包的内容"></a>四、ipa 包的内容</h2><p>例如，通过 iTunes Store 下载微信，获得 ipa 安装包，然后实际看看其安装包的内容。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-475c1b17e4bc6ae3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6"><br></center>

<ul>
<li>右键 ipa，重命名为 .zip</li>
<li>双击 zip 文件，解压缩后会得到一个文件夹。所以，<font color="#cc0000">ipa 包就是一个普通的压缩包</font>。</li>
</ul>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-a17d16dddf291011.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7"><br></center>

<ul>
<li>右键图中的 [WeChat[，选择显示包内容，然后就能够看到实际的 ipa 包内容了。</li>
</ul>
<h2 id="五、二进制文件的内容"><a href="#五、二进制文件的内容" class="headerlink" title="五、二进制文件的内容"></a>五、二进制文件的内容</h2><p>通过 XCode 的 Link Map File，我们可以窥探二进制文件中布局。在 XCode -&gt; Build Settings -&gt; 搜索 map -&gt; 开启Write Link Map File。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-ad796aa51811238f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8"><br></center>

<p>开启后，再编译，我们可以在对应的 Debug/Release 目录下看到对应的 link map 的 text 文件。</p>
<p>默认的目录：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Developer/Xcode/DerivedData/&lt;<span class="keyword">TARGET</span>-<span class="keyword">NAME</span>&gt;-对应ID/Build/Intermediates/&lt;<span class="keyword">TARGET</span>-<span class="keyword">NAME</span>&gt;.build/Debug-iphoneos/&lt;<span class="keyword">TARGET</span>-<span class="keyword">NAME</span>&gt;.build/</span><br></pre></td></tr></table></figure>
<p>例如 TargetName是 Demo 的目录：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/Users/</span>cykj<span class="regexp">/Library/</span>Developer<span class="regexp">/Xcode/</span>DerivedData<span class="regexp">/Demo-bifdsullasutjrbgiiywunmnlmjf/</span>Build<span class="regexp">/Intermediates.noindex/</span>Demo.build<span class="regexp">/Debug-iphonesimulator/</span>Demo.build</span><br></pre></td></tr></table></figure>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-9879ec4e25c96df9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9"><br></center>

<p>这个映射文件的主要包含以下部分：</p>
<ol>
<li><p>Object files</p>
<p> 这个部分包括的内容：</p>
<ul>
<li>.o 文文件，也就是上文提到的 .m 文件编译后的结果。</li>
<li>.a 文件</li>
<li><p>需要 link 的 framework</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Arch: x86_64</span><br><span class="line"># Object files:</span><br><span class="line">[  0] linker synthesized</span><br><span class="line">[  1] dtrace</span><br><span class="line">[  2] /Users/cykj/Library/Developer/Xcode/DerivedData/Demo-bifdsullasutjrbgiiywunmnlmjf/<span class="keyword">Build</span>/Intermediates.noindex/Demo.<span class="keyword">build</span>/Debug-iphonesimulator/Demo.<span class="keyword">build</span>/Objects-normal/x86_64/MyProxy.o</span><br><span class="line">[  <span class="number">3</span>] /Users/cykj/Library/Developer/Xcode/DerivedData/Demo-bifdsullasutjrbgiiywunmnlmjf/<span class="keyword">Build</span>/Intermediates.noindex/Demo.<span class="keyword">build</span>/Debug-iphonesimulator/Demo.<span class="keyword">build</span>/Objects-normal/x86_64/ViewController.o</span><br><span class="line">[  <span class="number">4</span>] /Users/cykj/Library/Developer/Xcode/DerivedData/Demo-bifdsullasutjrbgiiywunmnlmjf/<span class="keyword">Build</span>/Intermediates.noindex/Demo.<span class="keyword">build</span>/Debug-iphonesimulator/Demo.<span class="keyword">build</span>/Objects-normal/x86_64/Person.o</span><br><span class="line">[  <span class="number">5</span>] /Users/cykj/Library/Developer/Xcode/DerivedData/Demo-bifdsullasutjrbgiiywunmnlmjf/<span class="keyword">Build</span>/Intermediates.noindex/Demo.<span class="keyword">build</span>/Debug-iphonesimulator/Demo.<span class="keyword">build</span>/Objects-normal/x86_64/MyOperation.o</span><br><span class="line">[  <span class="number">6</span>] /Users/cykj/Library/Developer/Xcode/DerivedData/Demo-bifdsullasutjrbgiiywunmnlmjf/<span class="keyword">Build</span>/Intermediates.noindex/Demo.<span class="keyword">build</span>/Debug-iphonesimulator/Demo.<span class="keyword">build</span>/Objects-normal/x86_64/main.o</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="number">130</span>] /Applications/Xcode10<span class="number">.1</span>.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator12<span class="number">.1</span>.sdk/<span class="keyword">System</span>/Library/Frameworks//CoreGraphics.framework/CoreGraphics.tbd</span><br></pre></td></tr></table></figure>
<p>这个区域的存储内容比较简单：前面是文件的编号，后面是文件的路径。文件的编号在后续会用到。</p>
</li>
</ul>
</li>
<li><p>Sections</p>
<p> 这个区域<font color="#cc0000">提供了各个段（Segment）和节（Section）在可执行文件中的位置和大小</font>。这个区域完整的描述了可执行文件中的全部内容。其中，段分为两种：</p>
<ul>
<li>__TEXT 代码段</li>
<li><p>__DATA 数据段</p>
<p>从 Sections 区域可以看到，代码段的 __text 节的地址是 0x100001000，大小是 0x000A5FF9，而二者相加的下一个位置正好是 __stubs 的位置 0x1000A6FFA。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># Sections: </span><br><span class="line"># 位置           大小            段       节 </span><br><span class="line"># Address       Size            <span class="meta">Segment</span> <span class="meta">Section</span></span><br><span class="line"><span class="number">0x100001000</span>	<span class="number">0x000A5FF9</span>	__TEXT	__text             // 代码</span><br><span class="line"><span class="number">0x1000A6FFA</span>	<span class="number">0x000003D8</span>	__TEXT	__stubs</span><br><span class="line"><span class="number">0x1000A73D4</span>	<span class="number">0x00000678</span>	__TEXT	__stub_helper</span><br><span class="line"><span class="number">0x1000A7A4C</span>	<span class="number">0x0000794A</span>	__TEXT	__objc_methname    // OC 方法名</span><br><span class="line"><span class="number">0x1000AF396</span>	<span class="number">0x000079F4</span>	__TEXT	__cstring          // 字符串</span><br><span class="line"><span class="number">0x1000B6D8A</span>	<span class="number">0x0000092C</span>	__TEXT	__objc_classname   // OC 类名</span><br><span class="line"><span class="number">0x1000B76B6</span>	<span class="number">0x00002293</span>	__TEXT	__objc_methtype    // OC 方法类型</span><br><span class="line"><span class="number">0x1000B9950</span>	<span class="number">0x000000E8</span>	__TEXT	__const            // 常量</span><br><span class="line"><span class="number">0x1000B9A38</span>	<span class="number">0x000043DC</span>	__TEXT	__gcc_except_tab</span><br><span class="line"><span class="number">0x1000BDE14</span>	<span class="number">0x0000004A</span>	__TEXT	__ustring</span><br><span class="line"><span class="number">0x1000BDE5E</span>	<span class="number">0x00000166</span>	__TEXT	__entitlements</span><br><span class="line"><span class="number">0x1000BDFC4</span>	<span class="number">0x0000037B</span>	__TEXT	__dof_RACSignal</span><br><span class="line"><span class="number">0x1000BE33F</span>	<span class="number">0x000002E8</span>	__TEXT	__dof_RACCompou</span><br><span class="line"><span class="number">0x1000BE628</span>	<span class="number">0x000009CC</span>	__TEXT	__unwind_info</span><br><span class="line"><span class="number">0x1000BF000</span>	<span class="number">0x00000010</span>	__DATA	__nl_symbol_ptr</span><br><span class="line"><span class="number">0x1000BF010</span>	<span class="number">0x000001B8</span>	__DATA	__got</span><br><span class="line"><span class="number">0x1000BF1C8</span>	<span class="number">0x00000520</span>	__DATA	__la_symbol_ptr</span><br><span class="line"><span class="number">0x1000BF6E8</span>	<span class="number">0x00005D28</span>	__DATA	__const</span><br><span class="line"><span class="number">0x1000C5410</span>	<span class="number">0x00002E80</span>	__DATA	__cfstring</span><br><span class="line"><span class="number">0x1000C8290</span>	<span class="number">0x00000268</span>	__DATA	__objc_classlist   // OC 方法列表</span><br><span class="line"><span class="number">0x1000C84F8</span>	<span class="number">0x000001C0</span>	__DATA	__objc_catlist</span><br><span class="line"><span class="number">0x1000C86B8</span>	<span class="number">0x00000098</span>	__DATA	__objc_protolist   // OC 协议列表</span><br><span class="line"><span class="number">0x1000C8750</span>	<span class="number">0x00000008</span>	__DATA	__objc_imageinfo</span><br><span class="line"><span class="number">0x1000C8758</span>	<span class="number">0x0000F0C0</span>	__DATA	__objc_const       // OC 常量</span><br><span class="line"><span class="number">0x1000D7818</span>	<span class="number">0x00001B28</span>	__DATA	__objc_selrefs</span><br><span class="line"><span class="number">0x1000D9340</span>	<span class="number">0x00000040</span>	__DATA	__objc_protorefs</span><br><span class="line"><span class="number">0x1000D9380</span>	<span class="number">0x00000360</span>	__DATA	__objc_classrefs</span><br><span class="line"><span class="number">0x1000D96E0</span>	<span class="number">0x00000170</span>	__DATA	__objc_superrefs   // OC 父类引用</span><br><span class="line"><span class="number">0x1000D9850</span>	<span class="number">0x00000610</span>	__DATA	__objc_ivar        // OC ivar</span><br><span class="line"><span class="number">0x1000D9E60</span>	<span class="number">0x00001810</span>	__DATA	__objc_data</span><br><span class="line"><span class="number">0x1000DB670</span>	<span class="number">0x00000768</span>	__DATA	__data</span><br><span class="line"><span class="number">0x1000DBDD8</span>	<span class="number">0x0000015F</span>	__DATA	__bss</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Symbols</p>
<p> <font color="#cc0000">Section 部分将二进制文件进行了一级划分。而 Symbols 对 Section 中的各个段进行了二级划分</font>，例如，对于 __TEXT __text 表示代码段中的代码内容。</p>
 <figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x100001000</span>	<span class="number">0x000A5FF9</span>	__TEXT	__text             <span class="comment">// 代码</span></span><br></pre></td></tr></table></figure>
<p> 而对应的 Symbols，起始地址也是 0x1000021B0。其中，文件编号和上文的编号对应</p>
 <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x100001000</span>	<span class="number">0x000000A0</span>	[  <span class="number">2</span>] +[MyProxy <span class="string">proxyWithObj:</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ <span class="number">2</span>] <span class="regexp">/Users/</span>cykj<span class="regexp">/Library/</span>Developer<span class="regexp">/Xcode/</span>DerivedData<span class="regexp">/Demo-bifdsullasutjrbgiiywunmnlmjf/</span>Build<span class="regexp">/Intermediates.noindex/</span>Demo.build<span class="regexp">/Debug-iphonesimulator/</span>Demo.build<span class="regexp">/Objects-normal/</span>x86_64/MyProxy.o</span><br></pre></td></tr></table></figure>
<p> 具体内容：</p>
 <figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Symbols:</span><br><span class="line"># 地址           大小            文件编号 方法名</span><br><span class="line"># Address	Size    	File  Name</span><br><span class="line"><span class="number">0x100001000</span>	<span class="number">0</span>x<span class="number">000000A0</span>	[  <span class="number">2</span>] +[MyProxy proxyWithObj:]</span><br><span class="line"><span class="number">0</span>x<span class="number">1000010A0</span>	<span class="number">0x00000040</span>	[  <span class="number">2</span>] -[MyProxy methodSignatureForSelector:]</span><br><span class="line"><span class="number">0</span>x<span class="number">1000010E0</span>	<span class="number">0</span>x<span class="number">000003F0</span>	[  <span class="number">2</span>] -[MyProxy forwardInvocation:]</span><br><span class="line"><span class="number">0</span>x<span class="number">1000014D0</span>	<span class="number">0x00000040</span>	[  <span class="number">2</span>] -[MyProxy .cxx_destruct]</span><br><span class="line"><span class="number">0x100001510</span>	<span class="number">0x00000048</span>	[  <span class="number">2</span>] -[Dog barking:]</span><br><span class="line"><span class="number">0x100001560</span>	<span class="number">0x00000060</span>	[  <span class="number">3</span>] -[ViewController dealloc]</span><br><span class="line"><span class="number">0</span>x<span class="number">1000015C0</span>	<span class="number">0</span>x<span class="number">000001C0</span>	[  <span class="number">3</span>] -[ViewController drawImage:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>到这里，我们知道 OC 的方法是如何存储的，再来看看 ivar 是如何存储的。</p>
<p>首先找到数据栈中 __DATA __objc_ivar</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>x<span class="number">1000D9850</span>	<span class="number">0x00000610</span>	__DATA	__objc_ivar</span><br></pre></td></tr></table></figure>
<p>然后，搜索这个地址 0x1000D9850，就能找到 ivar 的存储区域。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1000D9850</span>	<span class="number">0x00000008</span>	[  <span class="number">2</span>] _OBJC_IVAR_$_MyProxy.__innerObj</span><br></pre></td></tr></table></figure>
<p>值得一提的是，对于 String，会显式的存储到数据段中，例如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1000AF3F2</span>	<span class="number">0x00000004</span>	[  <span class="number">3</span>] literal <span class="string">string:</span> <span class="string">http:</span><span class="comment">//www.baidu.com</span></span><br></pre></td></tr></table></figure>
<p>所以，若果你的加密 Key 以明文的形式写在文件里，是一件很危险的事情。</p>
<h2 id="六、dSYM-文件"><a href="#六、dSYM-文件" class="headerlink" title="六、dSYM 文件"></a>六、dSYM 文件</h2><p>在每次编译过后，都会生成一个 dsym 文件。<font color="#cc0000">dsym 文件中，存储了 16 进制的函数地址映射</font>。</p>
<p>在 App 实际执行的二进制文件中，是通过地址来调用方法的。在 App crash 的时候，第三方工具（Fabric、友盟等）会帮我们抓到崩溃的调用栈，调用栈里会包含 crash 地址的调用信息。然后通过 dSYM 文件，我们就可以由地址映射到具体的函数位置。</p>
<p>XCode 中选择 Window -&gt; Organizer 可以看到生成的 archier 文件。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-6d216b1dd05b7413.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10"><br></center>

<p>然后</p>
<ul>
<li>右键 -> 在 finder 中显示。</li>
<li>右键 -> 查看包内容。</li>
</ul>
<p>关于如何用 dsym 文件来分析崩溃位置，查看另一篇博客：<a href="http://blog.csdn.net/hello_hwc/article/details/50036323" target="_blank" rel="noopener">iOS 如何调试第三方统计到的崩溃报告</a></p>
<h2 id="七、应用场景"><a href="#七、应用场景" class="headerlink" title="七、应用场景"></a>七、应用场景</h2><h4 id="7-1-attribute"><a href="#7-1-attribute" class="headerlink" title="7.1 __attribute__"></a>7.1 __attribute__</h4><p>或多或少都会在第三方库或者 iOS 的头文件中，见到过 __attribute__。比如</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__attribute__ <span class="comment">((warn_unused_result)</span>) <span class="comment">// 如果没有使用返回值，编译的时候给出警告</span></span><br></pre></td></tr></table></figure>
<p><font color="#cc0000">__attribtue__ 是一个高级的的编译器指令</font>，它允许开发者指定更多的编译检查和一些高级的<font color="#cc0000">编译期优化</font>。</p>
<p>分为三种：</p>
<ul>
<li>函数属性（Function Attribute）</li>
<li>类型属性（Variable Attribute）</li>
<li>变量属性（Type Attribute）</li>
</ul>
<p>语法结构</p>
<pre><code>__attribute__ 语法格式为：__attribute__ ((attribute-list))
</code></pre><p>放在声明分号 “;” 前面。</p>
<p>比如，在三方库中最常见的，声明一个属性或者方法在当前版本弃用了。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">property</span><span class="title"> </span>(nonatomic, strong) CLASSNAME * <span class="keyword">property</span><span class="title"> </span>__deprecated;</span><br></pre></td></tr></table></figure>
<p>好处：</p>
<p>给开发者一个过渡的版本，让开发者知道这个属性被弃用了，应当使用最新的 API，但是被 __deprecated 的属性仍然可以正常使用。如果直接弃用，会导致开发者在更新 Pod 的时候，代码无法运行了。</p>
<p>__attribtue__ 的使用场景很多，本文只列举 iOS 开发中常用的几个：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 弃用 API，用作 API 更新</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">__deprecated</span>	<span class="selector-tag">__attribute__</span>((deprecated)) </span><br><span class="line"></span><br><span class="line"><span class="comment">// 带描述信息的弃用</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">__deprecated_msg</span>(_msg) <span class="selector-tag">__attribute__</span>((deprecated(_msg)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遇到 __unavailable 的变量/方法，编译器直接抛出 Error</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">__unavailable</span>	<span class="selector-tag">__attribute__</span>((unavailable))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 告诉编译器，即使这个变量/方法没被使用，也不要抛出警告</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">__unused</span>	<span class="selector-tag">__attribute__</span>((unused))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 和 __unused 相反</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">__used</span>		<span class="selector-tag">__attribute__</span>((used))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果不使用方法的返回值，进行警告</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">__result_use_check</span> <span class="selector-tag">__attribute__</span>((__warn_unused_result__))</span><br><span class="line"></span><br><span class="line"><span class="comment">// OC 方法在 Swift 中不可用</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">__swift_unavailable</span>(_msg)	<span class="selector-tag">__attribute__</span>((__availability__(swift, unavailable, message=_msg)))</span><br></pre></td></tr></table></figure>
<h4 id="7-2-Clang-警告处理"><a href="#7-2-Clang-警告处理" class="headerlink" title="7.2 Clang 警告处理"></a>7.2 Clang 警告处理</h4><p>你一定还见过如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic ignored <span class="meta-string">"-Wundeclared-selector"</span></span></span><br><span class="line"><span class="comment">/// 代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic pop</span></span><br></pre></td></tr></table></figure>
<p>这段代码的作用是</p>
<ol>
<li><font color="#cc0000">对当前编译环境进行压栈</font></li>
<li>忽略 -Wundeclared-selector（未声明的）Selector 警告</li>
<li>编译代码</li>
<li>对编译环境进行出栈</li>
</ol>
<p>通过 clang diagnostic push/pop 可以灵活的控制代码块的编译选项。</p>
<p>在另一篇文章：<a href="http://blog.csdn.net/Hello_Hwc/article/details/46425503" target="_blank" rel="noopener">iOS 合理利用 Clang 警告来提高代码质量</a>，详细的介绍了 XCode 的警告相关内容。</p>
<h4 id="7-3-预处理"><a href="#7-3-预处理" class="headerlink" title="7.3 预处理"></a>7.3 预处理</h4><p>所谓预处理，就是在编译之前的处理。<font color="#cc0000">预处理能够让你定义编译器变量，实现条件编译</font>。</p>
<p>比如，这样的代码很常见</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>我们同样也可以定义其他预处理变量，在 XCode -&gt; 选中 Target -&gt; build settings 中，搜索 preprocessor。可以分别为 Debug 和 Release 两种模式设置预处理宏。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-f44b0523ec2d7d28.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11"><br></center>

<p>比如加上：TESTMODE = 1，表示在这个宏中的代码运行在测试服务器。</p>
<p>然后，配合多个 Target（右键 Target，选择 Duplicate），单独一个 Target 负责测试服务器。这样就不用每次切换测试服务器都要修改代码了。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-9e591436b1f5e436.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12"><br></center>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TESTMODE</span></span><br><span class="line"><span class="comment">// 测试服务器相关的代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// 生产服务器相关代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="7-4-插入脚本"><a href="#7-4-插入脚本" class="headerlink" title="7.4 插入脚本"></a>7.4 插入脚本</h4><p>通常，如果你使用 CocoaPod 来管理三方库，那么你的 Build Phase 是这样子的：</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-cbf92c80a034e8ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="13"><br></center>

<p>其中：[CP] 开头的就是 CocoaPod 插入的脚本。</p>
<ul>
<li>Check Pods Manifest.lock，用来检查 cocoapod 管理的三方库是否需要更新</li>
<li>Embed Pods Framework，运行脚本来链接三方库的静态/动态库</li>
<li>Copy Pods Resources，运行脚本来拷贝三方库的资源文件</li>
</ul>
<p>而这些配置信息都存储在这个文件（.xcodeproj）里。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-204e1892f65add4d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14"><br></center>

<p>到这里，CocoaPod 的原理也就大致搞清楚了，<font color="#cc0000">通过修改 xcodeproject，然后配置编译期脚本</font>，来保证三方库能够正确的编译连接。</p>
<p>同样，我们也可以插入自己的脚本来做一些额外的事情。比如，每次进行 archive 的时候，我们都必须手动调整 target 的 build 版本，如果一不小心，就会忘记。这个过程，我们可以通过插入脚本自动化。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">buildNumber</span>=$(/usr/libexec/PlistBuddy -c <span class="string">"Print CFBundleVersion"</span> <span class="string">"<span class="variable">$&#123;PROJECT_DIR&#125;</span>/<span class="variable">$&#123;INFOPLIST_FILE&#125;</span>"</span>)</span><br><span class="line"><span class="attribute">buildNumber</span>=$(($buildNumber + 1))</span><br><span class="line">/usr/libexec/PlistBuddy -c <span class="string">"Set :CFBundleVersion <span class="variable">$buildNumber</span>"</span> <span class="string">"<span class="variable">$&#123;PROJECT_DIR&#125;</span>/<span class="variable">$&#123;INFOPLIST_FILE&#125;</span>"</span></span><br></pre></td></tr></table></figure>
<p>这段脚本其实很简单，读取当前 plist 的 build 版本号，然后对其 +1，重新写入。</p>
<p>使用起来也很简单：</p>
<ul>
<li>Xcode -&gt; 选中 Target -&gt; 选中 build phase</li>
<li>选择添加 Run Script Phase</li>
</ul>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-7390774f5a869394.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="15"><br></center>

<ul>
<li>然后把这段脚本拷贝进去，并且勾选 Run Script Only When installing，保证只有我们在安装到设备上的时候，才会执行这段脚本。重命名脚本的名字为 Auto Increase build number</li>
</ul>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-1bbe50512c4a785c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="16"><br></center>

<ul>
<li>然后，拖动这个脚本的到 Link Binary With Libraries 下面。</li>
</ul>
<h4 id="7-5-脚本编译打包"><a href="#7-5-脚本编译打包" class="headerlink" title="7.5 脚本编译打包"></a>7.5 脚本编译打包</h4><p>脚本化编译打包对于 CI（持续集成）来说，十分有用。iOS 开发中，编译打包必备的两个命令是：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译成.app</span></span><br><span class="line">xcodebuild  -workspace <span class="variable">$projectName</span><span class="selector-class">.xcworkspace</span> -scheme <span class="variable">$projectName</span>  -configuration <span class="variable">$buildConfig</span> clean build SYMROOT=<span class="variable">$buildAppToDir</span></span><br><span class="line"><span class="comment">// 打包</span></span><br><span class="line">xcrun -sdk iphoneos PackageApplication -v <span class="variable">$appDir</span>/<span class="variable">$projectName</span><span class="selector-class">.app</span> -o <span class="variable">$appDir</span>/<span class="variable">$ipaName</span>.ipa</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 info 命令，可以查看到详细的文档</span></span><br><span class="line">info xcodebuild</span><br></pre></td></tr></table></figure>
<p>在本文最后的附录中，提供一个自动打包的脚本。</p>
<h4 id="7-6-提高项目编译速度"><a href="#7-6-提高项目编译速度" class="headerlink" title="7.6 提高项目编译速度"></a>7.6 提高项目编译速度</h4><p>通常，当项目很大，源代码和三方库引入很多的时候，我们会发现编译的速度很慢。在了解了 XCode 的编译过程后，我们可以从以下角度来优化编译速度。</p>
<ol>
<li><p>查看编译时间</p>
<p> 我们需要一个途径，能够看到编译的时间，这样才能有个对比，知道我们的优化究竟有没有效果。</p>
<p> 对于 XCode 8，关闭 XCode，终端输入以下指令</p>
 <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ defaults write com<span class="selector-class">.apple</span><span class="selector-class">.dt</span><span class="selector-class">.Xcode</span> ShowBuildOperationDuration YES</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>然后，重启 XCode，再编译，你会在这里看到编译时间。

&lt;center&gt;
![17](https://upload-images.jianshu.io/upload_images/5294842-699c09578e290bc1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
&lt;/center&gt;
</code></pre><ol start="2">
<li><p>代码层面的优化</p>
<ul>
<li><p>forward declaration</p>
<p>所谓 forward declaration，就是 @class CLASSNAME，而不是 #import CLASSNAME.h。这样，编译器能大大<font color="#cc0000">提高 #import 的替换速度</font>。</p>
</li>
<li><p>对常用的工具类进行打包（Framework/.a）</p>
<p>打包成 Framework 或者静态库，这样编译的时候这部分代码就<font color="#cc0000">不需要重新编译</font>了。</p>
</li>
<li><p>常用头文件放到预编译文件里</p>
<p>pch 文件是预编译文件，这里的内容在执行 XCode build 之前就已经被预编译，并且引入到了每一个 .m 文件里。</p>
</li>
</ul>
</li>
<li><p>编译器选项优化</p>
<ul>
<li><p>Debug 模式下，不生成 dsym 文件</p>
<p>上文提到了，dysm 文件里存储了调试信息，在 Debug 模式下，我们可以借助 XCode 和 LLDB 进行调试。所以，不需要生成额外的 dsym 文件来降低编译速度。</p>
</li>
<li><p>Debug 开启 Build Active Architecture Only</p>
<p>在 XCode -&gt; Build Settings -&gt; Build Active Architecture Only 改为 YES。这样做，可以只编译当前的版本，比如 arm7/arm64 等等，记得只开启 Debug 模式。这个选项在高版本的 XCode 中自动开启了。</p>
</li>
<li><p>Debug 模式下，关闭编译器优化</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-69b06dd791e83926.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="18"><br></center>


</li>
</ul>
</li>
</ol>
<h2 id="八、附录"><a href="#八、附录" class="headerlink" title="八、附录"></a>八、附录</h2><p>自动编译打包脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LC_ALL=zh_CN.GB2312;</span><br><span class="line"><span class="built_in">export</span> LANG=zh_CN.GB2312</span><br><span class="line">buildConfig=<span class="string">"Release"</span> //这里是build模式</span><br><span class="line">projectName=[find . -name *.xcodeproj | awk -F <span class="string">"[/.]"</span> <span class="string">'&#123;print $(NF-1)&#125;'</span>[</span><br><span class="line">projectDir=[<span class="built_in">pwd</span>[</span><br><span class="line">wwwIPADir=~/Desktop/<span class="variable">$projectName</span>-IPA</span><br><span class="line">isWorkSpace=<span class="literal">true</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"~~~~~~~~~~~~~~~~~~~开始编译~~~~~~~~~~~~~~~~~~~"</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$wwwIPADir</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$wwwIPADir</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"文件目录存在"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"文件目录不存在"</span></span><br><span class="line">mkdir -pv <span class="variable">$wwwIPADir</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"创建<span class="variable">$&#123;wwwIPADir&#125;</span>目录成功"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$projectDir</span></span><br><span class="line">rm -rf ./build</span><br><span class="line">buildAppToDir=<span class="variable">$projectDir</span>/build</span><br><span class="line">infoPlist=<span class="string">"<span class="variable">$projectName</span>/Info.plist"</span></span><br><span class="line">bundleVersion=`/usr/libexec/PlistBuddy -c <span class="string">"Print CFBundleShortVersionString"</span> <span class="variable">$infoPlist</span>`</span><br><span class="line">bundleIdentifier=`/usr/libexec/PlistBuddy -c <span class="string">"Print CFBundleIdentifier"</span> <span class="variable">$infoPlist</span>`</span><br><span class="line">bundleBuildVersion=`/usr/libexec/PlistBuddy -c <span class="string">"Print CFBundleVersion"</span> <span class="variable">$infoPlist</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$isWorkSpace</span> ; <span class="keyword">then</span>  <span class="comment">#是否用CocoaPod</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"开始编译workspace...."</span></span><br><span class="line">xcodebuild  -workspace <span class="variable">$projectName</span>.xcworkspace -scheme <span class="variable">$projectName</span>  -configuration <span class="variable">$buildConfig</span> clean build SYMROOT=<span class="variable">$buildAppToDir</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"开始编译target...."</span></span><br><span class="line">xcodebuild  -target  <span class="variable">$projectName</span>  -configuration <span class="variable">$buildConfig</span> clean build SYMROOT=<span class="variable">$buildAppToDir</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> $? -eq 0</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"~~~~~~~~~~~~~~~~~~~编译成功~~~~~~~~~~~~~~~~~~~"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"~~~~~~~~~~~~~~~~~~~编译失败~~~~~~~~~~~~~~~~~~~"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ipaName=[<span class="built_in">echo</span> <span class="variable">$projectName</span> | tr <span class="string">"[:upper:]"</span> <span class="string">"[:lower:]"</span>[ <span class="comment">#将项目名转小写</span></span><br><span class="line">findFolderName=[find . -name <span class="string">"<span class="variable">$buildConfig</span>-*"</span> -<span class="built_in">type</span> d |xargs basename[ <span class="comment">#查找目录</span></span><br><span class="line">appDir=<span class="variable">$buildAppToDir</span>/<span class="variable">$findFolderName</span>/  <span class="comment">#app所在路径</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"开始打包<span class="variable">$projectName</span>.app成<span class="variable">$projectName</span>.ipa....."</span></span><br><span class="line">xcrun -sdk iphoneos PackageApplication -v <span class="variable">$appDir</span>/<span class="variable">$projectName</span>.app -o <span class="variable">$appDir</span>/<span class="variable">$ipaName</span>.ipa</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">"<span class="variable">$appDir</span>/<span class="variable">$ipaName</span>.ipa"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"打包<span class="variable">$ipaName</span>.ipa成功."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"打包<span class="variable">$ipaName</span>.ipa失败."</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">path=<span class="variable">$wwwIPADir</span>/<span class="variable">$projectName</span>$(date +%Y%m%d%H%M%S).ipa</span><br><span class="line">cp -f -p <span class="variable">$appDir</span>/<span class="variable">$ipaName</span>.ipa <span class="variable">$path</span>   <span class="comment">#拷贝ipa文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"复制<span class="variable">$ipaName</span>.ipa到<span class="variable">$&#123;wwwIPADir&#125;</span>成功"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"~~~~~~~~~~~~~~~~~~~结束编译，处理成功~~~~~~~~~~~~~~~~~~~"</span></span><br></pre></td></tr></table></figure>
<h2 id="九、文章"><a href="#九、文章" class="headerlink" title="九、文章"></a>九、文章</h2><p><a href="https://blog.csdn.net/Hello_Hwc/article/details/53557308" target="_blank" rel="noopener">iOS编译过程的原理和应用</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/09/10/iOS/iOS原理/iOS 编译过程原理(1)/">http://yoursite.com/2019/09/10/iOS/iOS原理/iOS 编译过程原理(1)/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/09/10/iOS/iOS架构/iOS 组件化方案/" class="pre">组件化方案</a><a href="/2019/09/10/C/if-else、switch、while、for/" class="next">if-else、switch、while、for</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、前言"><span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、iOS-编译"><span class="toc-text">二、iOS 编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、执行一次-XCode-build-的流程"><span class="toc-text">三、执行一次 XCode build 的流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、ipa-包的内容"><span class="toc-text">四、ipa 包的内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、二进制文件的内容"><span class="toc-text">五、二进制文件的内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、dSYM-文件"><span class="toc-text">六、dSYM 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、应用场景"><span class="toc-text">七、应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-attribute"><span class="toc-text">7.1 __attribute__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-Clang-警告处理"><span class="toc-text">7.2 Clang 警告处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-预处理"><span class="toc-text">7.3 预处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-插入脚本"><span class="toc-text">7.4 插入脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-5-脚本编译打包"><span class="toc-text">7.5 脚本编译打包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-提高项目编译速度"><span class="toc-text">7.6 提高项目编译速度</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#八、附录"><span class="toc-text">八、附录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、文章"><span class="toc-text">九、文章</span></a></li></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS原理/iOS UmbrellaFramework/">iOS UmbrellaFramework</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS原理/iOS UmbrellaHeader/">iOS umbrella header</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS媒体/iOS 图片/">iOS 图片</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/05/iOS/iOS优化/iOS 优化实例/">iOS 优化实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/05/iOS/iOS原理/iOS 操作系统架构/">iOS 操作系统架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS架构/iOS 网络层设计/">iOS网络层设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS 类簇/">iOS 类簇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS OCR/">iOS OCR</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS IM/">iOS IM</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/30/iOS/iOS原理/iOS 推送/">iOS 推送</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GLSL/">GLSL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IT/">IT</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL/">OpenGL</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS优化/">iOS优化</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS动画/">iOS动画</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS原理/">iOS原理</a><span class="category-list-count">42</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS多线程/">iOS多线程</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS媒体/">iOS媒体</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS安全/">iOS安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS架构/">iOS架构</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">5</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p> 
京ICP备 - <a target="_blank" href="http://www.beian.miit.gov.cn">19039713号</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>