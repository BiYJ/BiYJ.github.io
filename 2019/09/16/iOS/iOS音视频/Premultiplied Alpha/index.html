<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Premultiplied Alpha | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Premultiplied Alpha</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Premultiplied Alpha</h1><div class="post-meta"><a href="/2019/09/16/iOS/iOS音视频/Premultiplied Alpha/#comments" class="comment-count"></a><p><span class="date">Sep 16, 2019</span><span><a href="/categories/iOS音视频/" class="category">iOS音视频</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>Xcode 的工程选项里有一项 Compress PNG Files，会对 PNG 进行 Premultiplied Alpha。游戏开发中会更加关注这个格式，省一些运行时计算。</p>
<p>Premultiplied Alpha 是什么呢？</p>
<p><a href="https://developer.nvidia.com/content/alpha-blending-pre-or-not-pre" target="_blank" rel="noopener">Alpha Blending: To Pre or Not To Pre</a> 这篇文章其实说的很清楚。还有《Real Time Rendering》</p>
<h2 id="一、Alpha-Blending"><a href="#一、Alpha-Blending" class="headerlink" title="一、Alpha Blending"></a>一、Alpha Blending</h2><p>要搞清楚这个问题，先得理解 Alpha 通道的工作原理。</p>
<p>最常见的像素表示格式是 RGBA8888 即 （r, g, b, a），每个通道 8 位，0~255。例如红色 60% 透明度就是（255, 0, 0, 153），为了表示方便，alpha 通道一般记成正规化后的 0~1 的浮点数，也就是（255, 0, 0, 0.6）。而 Premultiplied Alpha 则是把 RGB 通道乘以透明度也就是（r <em> a, g </em> a, b * a, a），50% 透明红色就变成了（153, 0, 0, 0.6）。</p>
<p><a href="https://www.baidu.com/s?wd=%E9%80%8F%E6%98%8E%E9%80%9A%E9%81%93&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">透明通道</a>在渲染的时候通过 Alpha Blending 产生作用，如果一个透明度为 a<sub>s</sub> 的颜色 C<sub>s</sub> 渲染到颜色 C<sub>d</sub> 上，混合后的颜色通过以下公式计算：</p>
<p>C<sub>o</sub> = a<sub>s</sub>C<sub>s</sub> + (1 − a<sub>s</sub>)C<sub>d</sub></p>
<p>以 60% 透明的红色渲染到白色背景为例：</p>
<p>C<sub>o</sub> = (255, 0, 0) * 0.6 + (255, 255, 255) *(1 − 0.6) = (255, 102, 102)</p>
<p>也就是说，从视觉上（255, 0, 0, 0.6）渲染到白色背景上和（255, 102, 102）是同一个颜色。如果颜色以 Premultiplied Alpha 形式存储，也就是 C<sub>s</sub> 已经乘以透明度了，所以混合公式变成了：</p>
<p>C<sub>o</sub> = C<sub>s</sub>′ + (1 − a<sub>s</sub>)C<sub>d</sub></p>
<h2 id="二、为什么要-Premultiplied-Alpha？"><a href="#二、为什么要-Premultiplied-Alpha？" class="headerlink" title="二、为什么要 Premultiplied Alpha？"></a>二、为什么要 Premultiplied Alpha？</h2><p>Premultiplied Alpha 后的像素格式变得不直观，因为在画图的时候都是先从调色板中选出一个 RGB 颜色，再单独设置透明度，如果 RGB 乘以透明度就搞不清楚原色是什么了。从前面的 Alpha Blending 公式可以看出，Premultiplied Alpha 之后，混合的时候可以<font color="#cc0000">少一次乘法，这可以提高一些效率</font>，但这并不是最主要的原因。最主要的原因是：</p>
<p><font color="#cc0000">没有 Premultiplied Alpha 的纹理无法进行 Texture Filtering</font>（除非使用最近邻插值）。</p>
<p>以最常见的 filtering 方式线性插值为例，一个宽 2px 高 1px 的图片，左边的像素是红色，右边是绿色 10% 透明度，如果把这个图片缩放到 1x1 的大小，那么缩放后 1 像素的颜色就是左右两个像素线性插值的结果，也就是把两个像素各个通道加起来除以2。如果使用没有 Premultiplied Alpha 的颜色进行插值，那么结果就是：</p>
<p>((255, 0, 0, 1) + (0, 255, 0, 0.1)) * 0.5 = (127, 127, 0, 0.55)</p>
<p>如果绿色 Premultiplied Alpha，也就是（0, 255 * 0.1, 0, 0.1），和红色混合后：</p>
<p>((255, 0, 0, 1) + (0, 25, 0, 0.1)) * 0.5 = (127, 25, 0, 0.55)</p>
<p>Premultiplied Alpha 最重要的意义是<font color="#cc0000">使得带透明度图片纹理可以正常的进行线性插值</font>。这样旋转、缩放或者非整数的纹理坐标才能正常显示，否则就会像上面的例子一样，在透明像素边缘附近产生奇怪的颜色。</p>
<h2 id="三、纹理处理"><a href="#三、纹理处理" class="headerlink" title="三、纹理处理"></a>三、纹理处理</h2><p>我们使用的 PNG 图片纹理，一般是不会 Premultiplied Alpha 的。游戏引擎在载入 PNG 纹理后会手动处理，然后再 glTexImage2D 传给 GPU，比如 Cocos2D-x 中的 CCImage::premultipliedAlpha：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void Image::premultipliedAlpha() &#123;</span><br><span class="line">    unsigned int* fourBytes = (unsigned int*)_data;</span><br><span class="line">    for (int i = 0; i &lt; _width * _height; i++) &#123;</span><br><span class="line">        unsigned char* p = _data + i * 4;</span><br><span class="line">        fourBytes[i] = CC_RGB_PREMULTIPLY_ALPHA(p[0], p[1], p[2], p[3]);</span><br><span class="line">    &#125;  </span><br><span class="line">    _hasPremultipliedAlpha = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而 GPU 专用的纹理格式，比如 PVR、ETC 一般在生成纹理都是默认 Premultiplied Alpha 的，这些格式一般是 GPU 硬解码，引擎用 CPU 处理会很慢。</p>
<p>总之 glTexImage2D 传给 GPU 的纹理数据最好都是 Multiplied Alpha 的，要么在生成纹理时由纹理工具 Pre-multiplied，要么载入纹理后由游戏引擎或 UI 框架 Post-multiplied。</p>
<h2 id="四、iOS-中的-Premultiplied-Alpha"><a href="#四、iOS-中的-Premultiplied-Alpha" class="headerlink" title="四、iOS 中的 Premultiplied Alpha"></a>四、iOS 中的 Premultiplied Alpha</h2><p>Core Graphics 的 CGImage.h 对图像透明度信息有如下定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef CF_ENUM(uint32_t, CGImageAlphaInfo)&#123;</span><br><span class="line">    // ...</span><br><span class="line">    /* For example, premultiplied RGBA */</span><br><span class="line">    kCGImageAlphaPremultipliedLast, </span><br><span class="line">    /* For example, premultiplied ARGB */ </span><br><span class="line">    kCGImageAlphaPremultipliedFirst, </span><br><span class="line">    // ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>预乘透明度（Premultiplied Alpha<strong>）</strong>图像简单地说，即每个颜色分量都乘以 alpha 通道值作为结果值：</p>
<pre><code>color.rgb *= color.alpha
</code></pre><p>为什么关注预乘透明度图像？微信团队因 AR 抢红包场景的 OpenGL 混色结果出错引起注意。</p>
<blockquote>
<p>Premultiplied alpha is better than conventional blending for several reasons:</p>
<p>It works properly when filtering alpha cutouts _(see below)_</p>
<p>It works properly when doing image composition _(stay tuned for my next post)_</p>
<p>It is a superset of both conventional and additive blending. If you set alpha to zero while RGB is non zero, you get an additive blend. This can be handy for particle systems that want to smoothly transition from additive glowing sparks to dark pieces of soot as the particles age.</p>
<p>It plays nice with <a href="https://link.jianshu.com?t=http://blogs.msdn.com/shawnhar/archive/2008/10/28/texture-compression.aspx" target="_blank" rel="noopener">DXT compression</a>, which only supports transparent pixels with an RGB of zero.</p>
<p>摘自：<a href="https://link.jianshu.com?t=https://blogs.msdn.microsoft.com/shawnhar/2009/11/06/premultiplied-alpha/" target="_blank" rel="noopener">Premultiplied alpha</a></p>
</blockquote>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/09/16/iOS/iOS音视频/Premultiplied Alpha/">http://yoursite.com/2019/09/16/iOS/iOS音视频/Premultiplied Alpha/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/09/16/iOS/iOS音视频/图片处理/" class="pre">图片处理</a><a href="/2019/09/16/iOS/iOS架构/垃圾代码/" class="next">添加垃圾代码</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、Alpha-Blending"><span class="toc-text">一、Alpha Blending</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、为什么要-Premultiplied-Alpha？"><span class="toc-text">二、为什么要 Premultiplied Alpha？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、纹理处理"><span class="toc-text">三、纹理处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、iOS-中的-Premultiplied-Alpha"><span class="toc-text">四、iOS 中的 Premultiplied Alpha</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS音视频/图片处理/">图片处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS音视频/Premultiplied Alpha/">Premultiplied Alpha</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS架构/垃圾代码/">添加垃圾代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/pthread_rwlock_t/">pthread_rwlock_t</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD实现/">GCD实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD/">GCD</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD深入/">GCD深入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS原理/NSProxy/">NSProxy</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/iOS/iOS架构/组件化方案/">组件化方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/iOS/iOS原理/iOS 编译过程原理(1)/">iOS 编译过程原理(1)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS优化/">iOS优化</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS原理/">iOS原理</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS多线程/">iOS多线程</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS架构/">iOS架构</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS音视频/">iOS音视频</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读源码/">阅读源码</a><span class="category-list-count">1</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p> 
京ICP备 - <a target="_blank" href="http://www.beian.miit.gov.cn">19039713号</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>