<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>App Thinning | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">App Thinning</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">App Thinning</h1><div class="post-meta"><a href="/2019/05/23/iOS/iOS原理/App Thinning/#comments" class="comment-count"></a><p><span class="date">May 23, 2019</span><span><a href="/categories/iOS原理/" class="category">iOS原理</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>App Thinning 可以译成”应用瘦身”。指的是 App Store 和操作系统在安装 iOS 或者 watchOS 的 app 的时候通过一系列的优化，尽可能减少安装包的大小，使得 app 以最小的合适的大小被安装到你的设备上。而这个过程包括了三个过程：slicing、bitcode、on-demand resources。</p>
<h2 id="一、slicing"><a href="#一、slicing" class="headerlink" title="一、slicing"></a>一、slicing</h2><p>App Slicing 在节省应用所需资源中发挥着最重要的作用。</p>
<p>很多应用需要在不同尺寸的设备上运行，针对这些不同的设备，它们内含不同的独立资源，而大部分是你的设备不需要的。所以App Store 会针对不同的设备制作不同的”简化版 App”，当你下载 app 时候只需要下载不同的”简化版 app”就可以了。</p>
<p>比如用户使用的是 iPhone 5c，它运行的是 32 位 CPU 和 GPU，并不支持 Metal API。但如果用户下载的是一款最新的通用游戏应用，它的二进制中含有 64 位代码，iPad 和”@3x”iPhone 6 Plus 资源以及 Metal API 代码，这些都是你的设备用不上的。它只需要 32 位代码，”@2x”iPhone 尺寸资源以及 OpenGL 图形代码。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-2c4819d0348f492f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt><br></center>

<p><strong>Note : Sliced apps are supported on devices running 9.0 and later;</strong></p>
<p>Slicing 的主要的工作流程如下：</p>
<ol>
<li>在 Xcode 中选择好目标设备并且使用 asset catalog 提供多分辨率的图片资源；只有使用 asset catalog 才能正确使Slicing 作用于资源文件。</li>
<li>在模拟器或者设备上编译并运行 app；</li>
<li>Xcode 会自动构建针对你运行设备的”简化版 app”，同时也是为了减少编译时间和进行本地的测试；</li>
<li>打包 app（为了及时发现不同目标设备的配置错误，可以在本地为目标设备导出”简化版 app”，测试无误后再打包)</li>
<li>上传打包好的 app 到 iTunes connect。App Store 将会为上传的 app 归档创建不同的”简化版 app”。</li>
<li>在 iTunes Connect 中，发布一个预览版给合格的测试者进行测试；</li>
<li>测试者通过 TestFlight 下载预览版。TestFlight 会自动根据测试者的设备下载合适的”简化版 app”。</li>
</ol>
<h2 id="二、Bitcode-iOS-watchOS"><a href="#二、Bitcode-iOS-watchOS" class="headerlink" title="二、Bitcode (iOS, watchOS)"></a>二、Bitcode (iOS, watchOS)</h2><p>Bitcode 是一个编译好的程序的中间表示形式。上传到 iTunes Connect 中的包含 Bitcode 的 app 将会在 App Store 中进行链接和编译。苹果会对包含 Bitcode 的二进制 app 进行二次优化，而不需要提交一个新的 app 版本到 App Store 中。</p>
<h2 id="三、On-Demand-Resources-iOS"><a href="#三、On-Demand-Resources-iOS" class="headerlink" title="三、On-Demand Resources (iOS)"></a>三、On-Demand Resources (iOS)</h2><p>ODR（on-demand resources 随需应变资源)是 iOS 减少应用资源消耗的另外一种方法。比如多级游戏，用户需要的通常都是他们当前的级数以及下一级。ODR 意味着用户可以下载他们需要的几级游戏。随着你的级数不断增加，应用再下载其他级数，并将用户成功过关的级数删掉。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-3691bd525660ea81.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt><br></center>

<p>当用户点击应用内容的时候，就会动态从 App Store 上进行下载，也就是说用户只会在需要的时候占用存储空间。这项功能有趣之处还在于当将这些内容在后台进行下载之后，当存储空间紧张的时候会自动进行删除。</p>
<center><br><img src="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/On_Demand_Resources_Guide/Art/ODR_flow_2x.png" alt><br></center>

<p>On-Demand Resources 可以是除了可执行代码外的任意类型。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-66c28b72674b28d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt><br></center>

<p>在开发过程中，你可以通过分配一个或多个 tag 来识别 On-Demand Resources。你可以使用 tag 的别名来确定什么时候将它加载到你的 App 中。</p>
<p>好处：</p>
<ul>
<li>Smaller app size. app 体积更小。</li>
<li>Lazy loading of app resources. 懒加载应用资源。</li>
<li>Remote storage of rarely used resources. 远端存储较少使用的资源。</li>
<li>Remote storage of in-app purchase resources. 远端存储内购资源。</li>
</ul>
<p>下图展示了一个在 App 中保持最小资源占用的例子。</p>
<center><br><img src="https://upload-images.jianshu.io/upload_images/5294842-d1ee45f7ae6ebb73.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt><br><br><img src="https://upload-images.jianshu.io/upload_images/5294842-d5bfaeb1150e88bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt><br></center>

<p>可以给资源设置优先级，比如当 App 从 AppStore 安装后就立即加载。</p>
<blockquote>
<p> A _tag_ is a string identifier you create. Apps request tags, not individual resources.</p>
</blockquote>
<h4 id="3-1-On-Demand-Resources-的生命周期"><a href="#3-1-On-Demand-Resources-的生命周期" class="headerlink" title="3.1 On-Demand Resources 的生命周期"></a>3.1 On-Demand Resources 的生命周期</h4><ol>
<li><p>App 向操作系统请求资源。操作系统将请求发送给包含所有所需资源的 asset packs。</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-8053f6eb07507b8a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt><br> </center>
</li>
<li><p>asset packs 检查请求的资源本地是否存在。如果存在，则直接提供 App 使用。</p>
</li>
<li><p>如果请求的资源本地不存在，则它们被保存在 App Store。</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-316aab844be76e4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>
</li>
<li><p>操作系统开始下载本地不存在的资源</p>
</li>
<li><p>远程资源下载完毕</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-c5191d663f1b8e89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>
</li>
<li><p>当资源下载成功或监测到资源包已经被下载，资源包内存计数将会被 ＋1，并通知 App 此资源可用。</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-bbbb952f642fd22b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>
</li>
<li><p>当请求的资源可用，App 使用资源标签对应的资源。</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-9e2fc891d113fdac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>
</li>
<li><p>操作系统在本地释放资源标签</p>
</li>
<li><p>操作系统在本地清除资源缓存。当一个缓存资源不与任何请求相关联时，操作系统会在一定时间后将它释放掉。</p>
</li>
</ol>
<p>完整的生命周期如下图所示：</p>
<center><br><img src="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/On_Demand_Resources_Guide/Art/ODR_flow_2x.png" alt><br></center>

<h2 id="四、实际处理方法"><a href="#四、实际处理方法" class="headerlink" title="四、实际处理方法"></a>四、实际处理方法</h2><ol>
<li><p>iOS9 以后 Xcode 默认开启 On-Demand Resources 功能，可以在下图所示位置进行设置。</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-20fd1426c699a6c6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>
</li>
<li><p>在 App 中创建 Tags</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-1b4cfc77690df19f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br><br> <img src="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/On_Demand_Resources_Guide/Art/ODR_Add_New_Tag_2x.png" alt><br> </center>
</li>
<li><p>给文件设置 tag</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-62516bc6ffbdee87.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>
</li>
<li><p>给图片设置 tag</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-b56358b46094e85e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>
</li>
<li><p>给 tag 设置加载的优先级</p>
 <center><br> <img src="https://upload-images.jianshu.io/upload_images/5294842-e2b226aa8a0fdfd3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br> </center>

</li>
</ol>
<h4 id="4-1-加载优先级"><a href="#4-1-加载优先级" class="headerlink" title="4.1 加载优先级"></a>4.1 加载优先级</h4><ul>
<li>Initial install tags.资源和 App 同时下载。在 App Store 中，App 的大小计算已经包含了这部分资源。当没有NSBundleResourceRequest 对象访问它们时，它们将会从设备上清除。</li>
<li>Prefetch tag order. 在 App 安装后开始下载，按照预加载列表中的顺序依次下载。</li>
<li>Dowloaded only on demand. 只有在 App 中发出请求时才会下载。</li>
</ul>
<h4 id="4-2-资源大小限制"><a href="#4-2-资源大小限制" class="headerlink" title="4.2 资源大小限制"></a>4.2 资源大小限制</h4><center><br><img src="http://upload-images.jianshu.io/upload_images/3402279-ea2bc5a27c368c93.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/715" alt><br></center>

<h2 id="五、学习文章"><a href="#五、学习文章" class="headerlink" title="五、学习文章"></a>五、学习文章</h2><p><a href="https://help.apple.com/xcode/mac/current/#/devbbdc5ce4f" target="_blank" rel="noopener">What is app thinning? (iOS, tvOS, watchOS)</a><br><a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/On_Demand_Resources_Guide/index.html#//apple_ref/doc/uid/TP40015083" target="_blank" rel="noopener">On-Demand Resources Essentials</a><br><a href="https://www.jianshu.com/p/789df0adaac2" target="_blank" rel="noopener">https://www.jianshu.com/p/789df0adaac2</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/05/23/iOS/iOS原理/App Thinning/">http://yoursite.com/2019/05/23/iOS/iOS原理/App Thinning/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/05/23/iOS/iOS架构/协议分发/" class="pre">协议分发</a><a href="/2019/05/23/iOS/iOS原理/Bitcode(1)/" class="next">Bitcode（1）</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、slicing"><span class="toc-text">一、slicing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Bitcode-iOS-watchOS"><span class="toc-text">二、Bitcode (iOS, watchOS)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、On-Demand-Resources-iOS"><span class="toc-text">三、On-Demand Resources (iOS)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-On-Demand-Resources-的生命周期"><span class="toc-text">3.1 On-Demand Resources 的生命周期</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#四、实际处理方法"><span class="toc-text">四、实际处理方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-加载优先级"><span class="toc-text">4.1 加载优先级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-资源大小限制"><span class="toc-text">4.2 资源大小限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、学习文章"><span class="toc-text">五、学习文章</span></a></li></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS音视频/图片处理/">图片处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS音视频/Premultiplied Alpha/">Premultiplied Alpha</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS架构/垃圾代码/">添加垃圾代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/pthread_rwlock_t/">pthread_rwlock_t</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD实现/">GCD实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD/">GCD</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD深入/">GCD深入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS原理/NSProxy/">NSProxy</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/iOS/iOS架构/组件化方案/">组件化方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/iOS/iOS原理/iOS 编译过程原理(1)/">iOS 编译过程原理(1)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS优化/">iOS优化</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS原理/">iOS原理</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS多线程/">iOS多线程</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS架构/">iOS架构</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS音视频/">iOS音视频</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读源码/">阅读源码</a><span class="category-list-count">1</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p> 
京ICP备 - <a target="_blank" href="http://www.beian.miit.gov.cn">19039713号</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>