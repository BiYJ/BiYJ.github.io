<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>协议分发 | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">协议分发</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">协议分发</h1><div class="post-meta"><a href="/2019/05/23/iOS/iOS架构/iOS 协议分发/#comments" class="comment-count"></a><p><span class="date">May 23, 2019</span><span><a href="/categories/iOS架构/" class="category">iOS架构</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>Github：<a href="https://github.com/alessandroorru/AOMultiproxier" target="_blank" rel="noopener">AOMultiproxier</a>、<a href="https://github.com/panghaijiao/HJProtocolDispatcher" target="_blank" rel="noopener">HJProtocolDispatcher</a></p>
<p>协议实现分发器，能够轻易实现将协议事件分发给多个实现者。</p>
<h2 id="一、AOMultiproxier-h"><a href="#一、AOMultiproxier-h" class="headerlink" title="一、AOMultiproxier.h"></a>一、AOMultiproxier.h</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">AOMultiproxierForProtocol</span>(__protocol__, ...) ((AOMultiproxier &lt;__protocol__&gt; *)[AOMultiproxier <span class="attribute">multiproxierForProtocol</span>:<span class="variable">@protocol</span>(__protocol__) <span class="attribute">withObjects</span>:((NSArray *)[NSArray <span class="attribute">arrayWithObjects</span>:__VA_ARGS__,nil])])</span><br></pre></td></tr></table></figure>
<p>调用类方法的宏定义。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AOMultiproxier</span> : <span class="title">NSProxy</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) Protocol * protocol;  <span class="comment">// 协议</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> * attachedObjects;  <span class="comment">// 协议方法实现者</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)multiproxierForProtocol:(Protocol *)protocol </span><br><span class="line">						    withObjects:(<span class="built_in">NSArray</span>*)objects;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>AOMultiproxier 继承自 NSProxy 类，声明了两个只读属性和一个初始化方法。</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NS_ROOT_CLASS</span><br><span class="line">@<span class="class"><span class="keyword">interface</span> <span class="title">NSProxy</span> &lt;<span class="title">NSObject</span>&gt;&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">Class</span>   <span class="title">isa</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NSProxy 是一个类似于 NSObject 的根类，实现了 NSObject 协议。</p>
<p>苹果的官方文档描述：</p>
<blockquote>
<p>Typically, a message to a proxy is forwarded to the real object or causes the proxy to load (or transform itself into) the real object. Subclasses of NSProxy can be used to implement transparent distributed messaging (for example, NSDistantObject) or for lazy instantiation of objects that are expensive to create.</p>
<p>NSProxy implements the basic methods required of a root class, including those defined in the NSObject protocol. However, as an abstract class it doesn’t provide an initialization method, and it raises an exception upon receiving any message it doesn’t respond to. A concrete subclass must therefore provide an initialization or creation method and override the forwardInvocation: and methodSignatureForSelector: methods to handle messages that it doesn’t implement itself. A subclass’s implementation of forwardInvocation: should do whatever is needed to process the invocation, such as forwarding the invocation over the network or loading the real object and passing it the invocation. methodSignatureForSelector: is required to provide argument type information for a given message; a subclass’s implementation should be able to determine the argument types for the messages it needs to forward and should construct an NSMethodSignature object accordingly. See the NSDistantObject, NSInvocation, and NSMethodSignature class specifications for more information.</p>
</blockquote>
<p>NSProxy 仅仅是个转发消息的场所，至于如何转发，取决于派生类到底如何实现。比如可以在内部 hold 住（或创建）一个对象，然后把消息转发给该对象。那我们就可以在转发的过程中做些手脚了，甚至可以不去创建这些对象，去做任何你想做的事情，但是必须要实现他的 forwardInvocation: 和 methodSignatureForSelector: 方法。</p>
<h2 id="二、AOMultiproxier-m"><a href="#二、AOMultiproxier-m" class="headerlink" title="二、AOMultiproxier.m"></a>二、AOMultiproxier.m</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> AOMultiproxier()</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) Protocol * protocol;</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) NSOrderedSet * objects;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>私有 readwrite 属性。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)multiproxierForProtocol:(Protocol *)protocol withObjects:(<span class="built_in">NSArray</span> *)objects</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 调用实例方法  </span></span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">super</span> alloc] initWithProtocol:protocol objects:objects];;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithProtocol:(Protocol*)protocol objects:(<span class="built_in">NSArray</span>*)objects</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 保存协议</span></span><br><span class="line">    _protocol = protocol;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> * validObjects = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> oneConforms = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> objects) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断 object 是否遵守了 protocol 协议</span></span><br><span class="line">        <span class="keyword">if</span> ([object conformsToProtocol:protocol]) &#123;</span><br><span class="line">            oneConforms = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断 object 是否遵守了 protocol 协议或者 protocol 的父协议</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> _object:object inheritsProtocolOrAncestorOfProtocol:protocol]) &#123;</span><br><span class="line">            [validObjects addObject:object];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 没有任何对象遵守协议，触发断言</span></span><br><span class="line">    <span class="built_in">NSAssert</span>(oneConforms, <span class="string">@"You didn't attach any object that declares itself conforming to %@. At least one is needed."</span>, <span class="built_in">NSStringFromProtocol</span>(protocol));</span><br><span class="line">    </span><br><span class="line">    _objects = [<span class="built_in">NSOrderedSet</span> orderedSetWithArray:validObjects];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_objects.count &lt;= <span class="number">0</span> || !oneConforms) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化方法，给属性赋值。判断对象数组 objects 里的对象是否能够遵守了协议。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)conformsToProtocol:(Protocol*)protocol</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)conformsToProtocol:(Protocol *)aProtocol </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> protocol_conformsToProtocol(<span class="keyword">self</span>.protocol, aProtocol);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重写方法。在此处一直返回 YES，且未调用。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (NSArray *)attachedObjects</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="meta">[</span><span class="built_in">self</span>.objects <span class="built_in">array</span><span class="meta">]</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NSSet -》NSArray。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否能够响应 selector 方法。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)respondsToSelector:(SEL)selector </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> responds = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否是必须实现的协议方法（required）</span></span><br><span class="line">    <span class="built_in">BOOL</span> isMandatory = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取方法描述</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method_description methodDescription = [<span class="keyword">self</span> _methodDescriptionForSelector:selector</span><br><span class="line">                                                                               isMandatory:&amp;isMandatory];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isMandatory) &#123;</span><br><span class="line">        responds = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (methodDescription.name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 非必须实现的再检查 object 是否实现了协议方法</span></span><br><span class="line">        responds = [<span class="keyword">self</span> _checkIfAttachedObjectsRespondToSelector:selector];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> responds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转发消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    SEL selector = [anInvocation selector];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BOOL</span> isMandatory = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> objc_method_description methodDescription = [<span class="keyword">self</span> _methodDescriptionForSelector:selector </span><br><span class="line">                                                                               isMandatory:&amp;isMandatory];</span><br><span class="line">    <span class="comment">// 方法描述获取失败，调用 super 触发 crash</span></span><br><span class="line">    <span class="keyword">if</span> (methodDescription.name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> someoneResponded = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> <span class="keyword">self</span>.objects) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 可以响应，由 object 调用协议方法</span></span><br><span class="line">        <span class="keyword">if</span> ([object respondsToSelector:selector]) &#123;</span><br><span class="line">            [anInvocation invokeWithTarget:object];</span><br><span class="line">            someoneResponded = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If a mandatory method has not been implemented by any attached object, this would provoke a crash</span></span><br><span class="line">    <span class="comment">// 如果没有 required 方法没有被实现，调用 super 触发 crash</span></span><br><span class="line">    <span class="keyword">if</span> (isMandatory &amp;&amp; !someoneResponded) &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取方法签名，包含参数类型、返回值类型等信息。 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)selector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> * theMethodSignature;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BOOL</span> isMandatory = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_description methodDescription = [<span class="keyword">self</span> _methodDescriptionForSelector:selector </span><br><span class="line">                                                                               isMandatory:&amp;isMandatory];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (methodDescription.name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 方法描述 -&gt; 方法签名    </span></span><br><span class="line">    theMethodSignature = [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:methodDescription.types];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> theMethodSignature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息转发核心方法。检查 selector 对应的方法描述是否正确，并对 required 方法未实现的情况做出处理。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回方法描述</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">struct</span> objc_method_description)_methodDescriptionForSelector:(SEL)selector isMandatory:(<span class="built_in">BOOL</span> *)isMandatory</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_description method = &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// First check on main protocol. 当前协议查找</span></span><br><span class="line">    method = [<span class="keyword">self</span> _methodDescriptionInProtocol:<span class="keyword">self</span>.protocol selector:selector isMandatory:isMandatory];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If no method is known on main protocol, try on ancestor protocols. 在父协议查找</span></span><br><span class="line">    <span class="keyword">if</span> (method.name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        Protocol * __<span class="keyword">unsafe_unretained</span> * list = protocol_copyProtocolList(<span class="keyword">self</span>.protocol, &amp;count);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            Protocol * aProtocol = list[i];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Skip root protocol</span></span><br><span class="line">            <span class="keyword">if</span> ([<span class="built_in">NSStringFromProtocol</span>(aProtocol) isEqualToString:<span class="string">@"NSObject"</span>]) <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">            method = [<span class="keyword">self</span> _methodDescriptionInProtocol:aProtocol selector:selector isMandatory:isMandatory];</span><br><span class="line">            <span class="comment">// 找到了</span></span><br><span class="line">            <span class="keyword">if</span> (method.name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        free(list);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> method;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取方法描述</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">struct</span> objc_method_description)_methodDescriptionInProtocol:(Protocol *)protocol selector:(SEL)selector isMandatory:(<span class="built_in">BOOL</span> *)isMandatory</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_description method = &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 runtime 方法获取</span></span><br><span class="line">    method = protocol_getMethodDescription(protocol, selector, <span class="literal">YES</span>, <span class="literal">YES</span>);</span><br><span class="line">    <span class="keyword">if</span> (method.name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *isMandatory = <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    method = protocol_getMethodDescription(protocol, selector, <span class="literal">NO</span>, <span class="literal">YES</span>);</span><br><span class="line">    <span class="keyword">if</span> (method.name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *isMandatory = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际获取方法是 _methodDescriptionInProtocol:selector: isMandatory:，在方法内调用运行时方法  protocol_getMethodDescription，这个方法有四个参数，来看看各代表了什么。</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Returns a method description structure for a specified method of a given protocol.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> proto A protocol.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> aSel A selector.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isRequiredMethod A Boolean value that indicates whether aSel is a required method. 标识是否是必须实现的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isInstanceMethod A Boolean value that indicates whether aSel is an instance method. 标识是否是实例方法</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> An c objc_method_description structure that describes the method specified by e aSel,</span></span><br><span class="line"><span class="comment"> *  e isRequiredMethod, and e isInstanceMethod for the protocol e p.</span></span><br><span class="line"><span class="comment"> *  If the protocol does not contain the specified method, returns an c objc_method_description structure</span></span><br><span class="line"><span class="comment"> *  with the value c &#123;NULL, c NULL&#125;.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@note</span> This function recursively searches any protocols that this protocol conforms to.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OBJC_EXPORT struct objc_method_description</span><br><span class="line">protocol_getMethodDescription(Protocol * _Nonnull proto, SEL _Nonnull aSel,</span><br><span class="line">                              <span class="keyword">BOOL</span> isRequiredMethod, <span class="keyword">BOOL</span> isInstanceMethod)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.5</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<p>注意第三、四个参数即可。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)_checkIfAttachedObjectsRespondToSelector:(SEL)selector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> <span class="keyword">self</span>.objects) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([object respondsToSelector:selector]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检查 object 对象是否能够响应 selector 方法。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)_object:(<span class="keyword">id</span>)object inheritsProtocolOrAncestorOfProtocol:(Protocol*)protocol</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 在当前协议中查找</span></span><br><span class="line">    <span class="keyword">if</span> ([object conformsToProtocol:protocol]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> conforms = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    Protocol * __<span class="keyword">unsafe_unretained</span> * list = protocol_copyProtocolList(protocol, &amp;count);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在查找父协议中查找</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        Protocol * aProtocol = list[i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Skip root protocol. 如果查找到了 NSObject 协议，结束查找</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSStringFromProtocol</span>(aProtocol) isEqualToString:<span class="string">@"NSObject"</span>]) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 递归调用</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> _object:object inheritsProtocolOrAncestorOfProtocol:aProtocol]) &#123;</span><br><span class="line">            conforms = <span class="literal">YES</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(list);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> conforms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找 object 是否实现了协议方法。</p>
<h2 id="三、HJProtocolDispatcher-h"><a href="#三、HJProtocolDispatcher-h" class="headerlink" title="三、HJProtocolDispatcher.h"></a>三、HJProtocolDispatcher.h</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define AOProtocolDispatcher(__protocol__, ...)  \</span></span><br><span class="line">    [ProtocolDispatcher dispatcherProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">__protocol__</span>)  \</span></span><br><span class="line">                            toImplemertors:\[<span class="built_in">NSArray</span> arrayWithObjects:__VA_ARGS__, <span class="literal">nil</span>]]</span><br></pre></td></tr></table></figure>
<p>同样的宏定义，这里用了 \ 换行，更适合阅读。__VA_ARGS__ 是新的 C99 规范中新增的一个可变参数的宏，目前似乎只有 gcc 支持（<a href="https://www.baidu.com/s?wd=VC6.0&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">VC6.0</a>的编译器不支持），实现思想就是宏定义中参数列表的最后一个参数为 …。</p>
<h2 id="四、HJProtocolDispatcher-m"><a href="#四、HJProtocolDispatcher-m" class="headerlink" title="四、HJProtocolDispatcher.m"></a>四、HJProtocolDispatcher.m</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回方法描述</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> objc_method_description MethodDescriptionForSELInProtocol(Protocol *protocol, SEL sel) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// required 方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> objc_method_description description = protocol_getMethodDescription(protocol, sel, <span class="literal">YES</span>, <span class="literal">YES</span>);</span><br><span class="line">    <span class="keyword">if</span> (description.types) &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional 方法</span></span><br><span class="line">    description = protocol_getMethodDescription(protocol, sel, <span class="literal">NO</span>, <span class="literal">YES</span>);</span><br><span class="line">    <span class="keyword">if</span> (description.types) &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 未找到</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> objc_method_description)&#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断 protocol 是否包含 sel 方法 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">BOOL</span> ProtocolContainSel(Protocol *protocol, SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> MethodDescriptionForSELInProtocol(protocol, sel).types ? <span class="literal">YES</span>: <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>私有方法。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ImplemertorContext</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> implemertor;  <span class="comment">// 方法实现者，即最后调用方法的对象</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ImplemertorContext</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">ImplemertorContext 是每个实现者的封装。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ProtocolDispatcher</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Protocol * prococol;    <span class="comment">// 协议</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> * implemertors; <span class="comment">// 实现者数组</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ProtocolDispatcher</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">id</span>)dispatcherProtocol:(Protocol *)protocol toImplemertors:(<span class="built_in">NSArray</span> *)implemertors </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [[ProtocolDispatcher alloc] initWithProtocol:protocol toImplemertors:implemertors];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithProtocol:(Protocol *)protocol toImplemertors:(<span class="built_in">NSArray</span> *)implemertors </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.prococol = protocol;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *implemertorContexts = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:implemertors.count];</span><br><span class="line">        [implemertors enumerateObjectsUsingBlock:^(<span class="keyword">id</span> implemertor, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            ImplemertorContext *implemertorContext = [ImplemertorContext new];</span><br><span class="line">            implemertorContext.implemertor = implemertor;</span><br><span class="line">            [implemertorContexts addObject:implemertorContext];</span><br><span class="line">            objc_setAssociatedObject(implemertor, _cmd, <span class="keyword">self</span>, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="keyword">self</span>.implemertors = [implemertorContexts <span class="keyword">copy</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)respondsToSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果协议未包含方法，直接调用 super</span></span><br><span class="line">    <span class="keyword">if</span> (!ProtocolContainSel(<span class="keyword">self</span>.prococol, aSelector)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> respondsToSelector:aSelector];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (ImplemertorContext *implemertorContext <span class="keyword">in</span> <span class="keyword">self</span>.implemertors) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([implemertorContext.implemertor respondsToSelector:aSelector]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果协议未包含方法，直接调用 super </span></span><br><span class="line">    <span class="keyword">if</span> (!ProtocolContainSel(<span class="keyword">self</span>.prococol, aSelector)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> objc_method_description methodDescription = MethodDescriptionForSELInProtocol(<span class="keyword">self</span>.prococol, aSelector);</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:methodDescription.types];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    SEL aSelector = anInvocation.selector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果协议未包含方法，直接调用 super </span></span><br><span class="line">    <span class="keyword">if</span> (!ProtocolContainSel(<span class="keyword">self</span>.prococol, aSelector)) &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (ImplemertorContext *implemertorContext <span class="keyword">in</span> <span class="keyword">self</span>.implemertors) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([implemertorContext.implemertor respondsToSelector:aSelector]) &#123;</span><br><span class="line">            [anInvocation invokeWithTarget:implemertorContext.implemertor];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>HJProtocolDispatcher 与 AOMultiproxier 的思想和功能大体相同。</p>
<p>AO 功能更齐全，它会去父协议中检查方法是否存在，且对 required 方法添加了逻辑判断。</p>
<p>AO 继承自 NSProxy，HJ 继承自 NSObject。NSObject 寻找方法顺序：本类-&gt;父类-&gt;动态方法解析-&gt;消息转发；NSproxy 顺序：本类-&gt;消息转发，同样做“消息转发”，NSObject 会比 NSProxy 多做好多事，也就意味着耽误很多时间，所以 NSProxy 效率更高。</p>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/05/23/iOS/iOS架构/iOS 协议分发/">http://yoursite.com/2019/05/23/iOS/iOS架构/iOS 协议分发/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/05/23/C/尾调用（Tail Call）/" class="pre">尾调用（Tail Call）</a><a href="/2019/05/23/iOS/iOS原理/离屏渲染/" class="next">离屏渲染</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、AOMultiproxier-h"><span class="toc-text">一、AOMultiproxier.h</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、AOMultiproxier-m"><span class="toc-text">二、AOMultiproxier.m</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、HJProtocolDispatcher-h"><span class="toc-text">三、HJProtocolDispatcher.h</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、HJProtocolDispatcher-m"><span class="toc-text">四、HJProtocolDispatcher.m</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、总结"><span class="toc-text">五、总结</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS原理/iOS UmbrellaFramework/">iOS UmbrellaFramework</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS原理/iOS UmbrellaHeader/">iOS umbrella header</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/06/iOS/iOS媒体/iOS 图片/">iOS 图片</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/05/iOS/iOS优化/iOS 优化实例/">iOS 优化实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/05/iOS/iOS原理/iOS 操作系统架构/">iOS 操作系统架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS架构/iOS 网络层设计/">iOS网络层设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS 类簇/">iOS 类簇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS OCR/">iOS OCR</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/04/iOS/iOS原理/iOS IM/">iOS IM</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/30/iOS/iOS原理/iOS 推送/">iOS 推送</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GLSL/">GLSL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IT/">IT</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL/">OpenGL</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS优化/">iOS优化</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS动画/">iOS动画</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS原理/">iOS原理</a><span class="category-list-count">42</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS多线程/">iOS多线程</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS媒体/">iOS媒体</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS安全/">iOS安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS架构/">iOS架构</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">5</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p> 
京ICP备 - <a target="_blank" href="http://www.beian.miit.gov.cn">19039713号</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>