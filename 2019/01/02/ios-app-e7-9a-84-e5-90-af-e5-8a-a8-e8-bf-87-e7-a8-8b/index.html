<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title> iOS App的启动过程		 | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden"> iOS App的启动过程		</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title"> iOS App的启动过程		</h1><div class="post-meta"><a href="/2019/01/02/ios-app-e7-9a-84-e5-90-af-e5-8a-a8-e8-bf-87-e7-a8-8b/#comments" class="comment-count"></a><p><span class="date">Jan 02, 2019</span><span><a href="/categories/底层原理/" class="category">底层原理</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>原文：<a href="https://me.csdn.net/Hello_Hwc" target="_blank" rel="noopener">黄文臣</a> <a href="https://blog.csdn.net/hello_hwc/article/details/78317863" target="_blank" rel="noopener">深入理解 iOS App的启动过程</a></p>
<blockquote>
<p>启动时间是衡量应用品质的重要指标。</p>
</blockquote>
<p>本文首先会从原理上出发，讲解 iOS 系统是如何启动 App 的，然后从 main 函数之前和之后两个角度去分析如何优化启动时间。</p>
<h4 id="Mach-O"><a href="#Mach-O" class="headerlink" title="Mach-O"></a>Mach-O</h4><p>哪些名词指的是 Mach-o</p>
<ul>
<li>Executable 可执行文件</li>
<li>Dylib 动态库</li>
<li>Bundle 无法被连接的动态库，只能通过 dlopen() 加载</li>
<li>Image 指的是 Executable、Dylib 或者 Bundle 的一种，文中会多次使用 Image 这个名词。</li>
<li>Framework 动态库和对应的头文件和资源文件的集合</li>
</ul>
<p>Apple 出品的操作系统的可执行文件格式几乎都是 mach-o，iOS 当然也不例外。</p>
<p>mach-o 可以大致的分为三部分：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-baf0c6a470de89d7?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MachO"></p>
<ul>
<li>Header 头部，包含可以执行的 CPU 架构，比如 x86、arm64</li>
<li>Load commands 加载命令，包含文件的组织架构和在虚拟内存中的布局方式</li>
<li>Data 数据，包含 load commands 中需要的各个段（segment）的数据，每一个 Segment 的大小都是 Page 的整数倍。</li>
</ul>
<p>用 MachOView 打开工程的可以执行文件，来验证下 mach-o 的文件布局：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-f0011ff7297f64ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MachOView"></p>
<p>绝大多数 mach-o 包括以下三个段（支持用户自定义 Segment，但是很少使用）</p>
<p>__TEXT   代码段，只读。包括函数，和只读的字符串，上图中类似 __TEXT、<strong>text 的都是代码段<br>__DATA  数据段，读写。包括可读写的全局变量等，上图类似中的 __DATA、</strong>data 都是数据段<br>__LINKEDIT   包含了方法和变量的元数据（位置，偏移量），以及代码签名等信息。</p>
<p>关于 mach-o 更多细节，可以看看文档：《<a href="https://github.com/LeoMobileDeveloper/React-Native-Files/blob/master/Mac%20OS%20X%20ABI%20Mach-O%20File%20Format%20Reference.pdf" target="_blank" rel="noopener">Mac OS X ABI Mach-O File Format Reference</a>》。</p>
<h4 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a>dyld</h4><p>dyld 的全称是 <a href="https://developer.apple.com/library/content/releasenotes/DeveloperTools/RN-dyld/" target="_blank" rel="noopener">dynamic loader</a>，它的作用是加载一个进程所需要的 image，dyld 是<a href="https://opensource.apple.com/source/dyld/" target="_blank" rel="noopener">开源</a>的。</p>
<h4 id="Virtual-Memory"><a href="#Virtual-Memory" class="headerlink" title="Virtual Memory"></a>Virtual Memory</h4><blockquote>
<p>虚拟内存是在物理内存上建立的一个逻辑地址空间，它向上（应用）提供了一个连续的逻辑地址空间，向下隐藏了物理内存的细节。<br>虚拟内存使得逻辑地址可以没有实际的物理地址，也可以让多个逻辑地址对应到一个物理地址。<br>虚拟内存被划分为一个个大小相同的 Page（64 位系统上是 16KB），提高管理和读写的效率。 Page 又分为只读和读写的 Page。</p>
</blockquote>
<p>虚拟内存是建立在物理内存和进程之间的中间层。在 iOS 上，当内存不足的时候，会尝试释放那些只读的 Page，因为只读的Page 在下次被访问的时候，可以再次从磁盘读取。如果没有可用内存，会通知在后台的 App（也就是在这个时候收到了 memory warning），如果在这之后仍然没有可用内存，则会杀死在后台的 App。</p>
<h4 id="Page-fault"><a href="#Page-fault" class="headerlink" title="Page fault"></a>Page fault</h4><p>在应用执行的时候，它被分配的逻辑地址空间都是可以访问的，当应用访问一个逻辑 Page，而在对应的物理内存中并不存在的时候，这时候就发生了一次 Page fault。当 Page fault 发生的时候，会中断当前的程序，在物理内存中寻找一个可用的 Page，然后从磁盘中读取数据到物理内存，接着继续执行当前程序。</p>
<h4 id="Dirty-Page-amp-Clean-Page"><a href="#Dirty-Page-amp-Clean-Page" class="headerlink" title="Dirty Page &amp; Clean Page"></a>Dirty Page &amp; Clean Page</h4><ul>
<li>如果一个 Page 可以从磁盘上重新生成，那么这个 Page 称为 Clean Page</li>
<li>如果一个 Page 包含了进程相关信息，那么这个 Page 称为 Dirty Page</li>
</ul>
<p>像代码段这种只读的 Page 就是 Clean Page。而像数据段 _DATA 这种读写的 Page，当写数据发生的时候，会触发 COW（Copy on write），也就是写时复制，Page 会被标记成 Dirty，同时会被复制。</p>
<p>想要了解更多细节，可以阅读文档：<a href="https://developer.apple.com/library/content/documentation/Performance/Conceptual/ManagingMemory/ManagingMemory.html#//apple_ref/doc/uid/10000160-SW1" target="_blank" rel="noopener">Memory Usage Performance Guidelines</a></p>
<h4 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h4><p>使用 dyld2 启动应用的过程如图：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-5ee0e2ba7a15f73c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Dyld"></p>
<p>大致的过程如下：</p>
<ol>
<li>加载 dyld 到 App 进程</li>
<li>加载动态库（包括所依赖的所有动态库）</li>
<li>Rebase</li>
<li>Bind</li>
<li>初始化 Objective-C Runtime</li>
<li>其它的初始化代码</li>
</ol>
<h4 id="加载动态库"><a href="#加载动态库" class="headerlink" title="加载动态库"></a>加载动态库</h4><ol>
<li>首先，dyld 会读取 mach-o 文件的 Header 和 load commands。</li>
<li>接着，就知道了这个可执行文件依赖的动态库。例如加载动态库 A 到内存，接着检查 A 所依赖的动态库，就这样的递归加载，直到所有的动态库加载完毕。通常一个 App 所依赖的动态库在 100-400 个左右，其中大多数都是系统的动态库，它们会被缓存到 dyld shared cache，这样读取的效率会很高。</li>
</ol>
<p>查看 mach-o 文件所依赖的动态库，可以通过 MachOView 的图形化界面（展开 Load Command 就能看到)</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-bd5a463ca0dff370.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¾èµçå¨æåº"></p>
<p>也可以通过命令行：otool -L Demo</p>
<h4 id><a href="#" class="headerlink" title></a><img src="https://upload-images.jianshu.io/upload_images/5294842-479e0fb5e1e91c25.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="otool"></h4><p>Rebase &amp;&amp; Bind</p>
<p>这里先来讲讲为什么要 Rebase？</p>
<p>有两种主要的技术来保证应用的安全：ASLR 和 Code Sign。</p>
<p>ASLR 的全称是 Address space layout randomization，翻译过来就是“地址空间布局随机化”。App 启动的时候，程序会被影射到逻辑的地址空间，这个逻辑的地址空间有一个起始地址，而 ASLR 技术使得这个起始地址是随机的。如果是固定的，那么黑客很容易就可以由起始地址+偏移量找到函数的地址。</p>
<p>Code Sign 相信大多数开发者都知晓，这里要提一点的是，在进行 Code sign 的时候，加密哈希不是针对于整个文件，而是针对于每一个 Page 的。这就保证了在 dyld 进行加载的时候，可以对每一个 page 进行独立的验证。</p>
<p>mach-o 中有很多符号，有指向当前 mach-o 的，也有指向其他 dylib 的，比如 printf。那么，在运行时代码如何准确的找到 printf 的地址呢？</p>
<p>mach-o 中采用了 PIC 技术，全称是 Position Independ code。当你的程序要调用 printf 的时候，会先在 __DATA 段中建立一个指针指向 printf，再通过这个指针实现间接调用。dyld 这时候需要做一些 fix-up 工作，即帮助应用程序找到这些符号的实际地址。主要包括两部分：</p>
<ul>
<li>Rebase 修正内部（指向当前 mach-o 文件）的指针指向</li>
<li>Bind 修正外部指针指向</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-b11882c3085a4fc1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Rebase"></p>
<p>之所以需要 Rebase，是因为刚刚提到的 ASLR 使得地址随机化，导致起始地址不固定，另外由于 Code Sign，导致不能直接修改Image。Rebase 的时候只需要增加对应的偏移量即可。待 Rebase 的数据都存放在 __LINKEDIT 中。</p>
<p>可以通过 MachOView 查看：Dynamic Loader Info -&gt; Rebase Info</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-b75c07a2ae41d79d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ReBase"></p>
<p>也可以通过命令行：xcrun dyldinfo -bind Demo</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-29b136284222e2f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="xcrun"></p>
<p>Rebase 解决了内部的符号引用问题，而外部的符号引用则是由 Bind 解决。在解决 Bind 的时候，是根据字符串匹配的方式查找符号表，所以这个过程相对于 Rebase 来说是略慢的。</p>
<p>同样，也可以通过 xcrun dyldinfo 来查看 Bind 的信息，比如我们查看 bind 信息中，包含 UITableView 的部分：xcrun dyldinfo -bind demo | grep UITableView</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-a124004c20eada03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<h4 id="Objective-C"><a href="#Objective-C" class="headerlink" title="Objective-C"></a>Objective-C</h4><p>Objective-C 是动态语言，所以在执行 main 函数之前，需要把类的信息注册到一个全局的 Table 中。同时，Objective-C支持Category，在初始化的时候，也会把 Category 中的方法注册到对应的类中，同时会唯一 Selector，这也是为什么当你的 Cagegory实现了类中同名的方法后，类中的方法会被覆盖。</p>
<p>category 是实现了类似覆盖原同名方法的功能，但是实现上不是覆盖，而是将 category 的方法放到原方法的前面，methodlist 中就有了两个同名的方法，第一个方法是 category 方法，而第二个方法是原方法。这样在命中方法的时候，就会命中这个 category方法。 系统的实现方法是这样的：</p>
<p>for (uint32_t m = 0; (scanForCustomRR || scanForCustomAWZ) &amp;&amp; m &lt; mlist&gt;count; m++) {</p>
<pre><code>SEL sel = method\_list\_nth(mlist, m)-&gt;name;

if (scanForCustomRR &amp;&amp; isRRSelector(sel)) {
    cls-&gt;setHasCustomRR();
    scanForCustomRR = false;
}
else if (scanForCustomAWZ &amp;&amp; isAWZSelector(sel)) {
    cls-&gt;setHasCustomAWZ();
    scanForCustomAWZ = false;
}
</code></pre><p>}</p>
<p>// Fill method list array<br>newLists[newCount++] = mlist;<br>…</p>
<p>// Copy old methods to the method list array<br>for (i = 0; i &lt; oldCount; i++) {<br>    newLists[newCount++] = oldLists[i];<br>}</p>
<p>另外，由于 iOS 开发是基于 Cocoa Touch 的，所以绝大多数的类起始都是系统类，所以大多数的 Runtime 初始化起始在 Rebase和 Bind 中已经完成。</p>
<h4 id="Initializers"><a href="#Initializers" class="headerlink" title="Initializers"></a>Initializers</h4><p>接下来就是必要的初始化部分了，主要包括几部分：</p>
<ul>
<li>+load方法。</li>
<li>C／C++ 静态初始化对象和标记为 __attribute__(constructor) 的方法</li>
</ul>
<p>这里要提一点的就是，+load 方法已经被弃用了，如果你用 Swift 开发，你会发现根本无法去写这样一个方法，官方的建议是使用 initialize。区别就是，load 是在类装载的时候执行，而 initialize 是在类第一次收到 message 前调用。</p>
<h4 id="dyld3"><a href="#dyld3" class="headerlink" title="dyld3"></a>dyld3</h4><p>上文的讲解是 dyld2 的加载方式。而最新的是 dyld3 加载方式略有不同：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-eaeac61c86e0ca52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="dyld3"></p>
<p>dyld2 是纯粹的 in-process，也就是在程序进程内执行的，也就意味着只有当应用程序被启动的时候，dyld2 才能开始执行任务。</p>
<p>dyld3 则是部分 out-of-process，部分 in-process。图中，虚线之上的部分是 out-of-process 的，在 App 下载安装和版本更新的时候会去执行，out-of-process 会做如下事情：</p>
<ul>
<li>分析Mach-o Headers</li>
<li>分析依赖的动态库</li>
<li>查找需要Rebase &amp; Bind之类的符号</li>
<li><p>把上述结果写入缓存</p>
<p>这样，在应用启动的时候，就可以直接从缓存中读取数据，加快加载速度。</p>
</li>
</ul>
<h4 id="启动时间"><a href="#启动时间" class="headerlink" title="启动时间"></a>启动时间</h4><p><strong>冷启动 VS 热启动</strong></p>
<blockquote>
<p>如果你刚刚启动过 App，这时候 App 的启动所需要的数据仍然在缓存中，再次启动的时候称为热启动。如果设备刚刚重启，然后启动 App，这时候称为冷启动。</p>
</blockquote>
<p>启动时间小于 400ms 是最佳的，因为从点击图标到显示 Launch Screen，到 Launch Screen 消失这段时间是400ms。启动时间不可以大于 20s，否则会被系统杀掉。</p>
<p>在 Xcode 中，可以通过设置环境变量来查看 App 的启动时间，DYLD_PRINT_STATISTICS 和DYLD_PRINT_STATISTICS_DETAILS。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-81f3427ba27330b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="DYLD_PRINT_STATISTICS"></p>
<p>Total pre-main time: 582.39 milliseconds (100.0%)<br>         dylib loading time: 169.23 milliseconds (29.0%)<br>        rebase/binding time: 337.04 milliseconds (57.8%)<br>            ObjC setup time:  44.48 milliseconds (7.6%)<br>           initializer time:  31.52 milliseconds (5.4%)<br>           slowest intializers :<br>             libSystem.B.dylib :  12.06 milliseconds (2.0%)<br>    libMainThreadChecker.dylib :  12.12 milliseconds (2.0%)</p>
<p>  total time: 904.01 milliseconds (100.0%)<br>  total images loaded:  257 (0 from dyld shared cache)<br>  total segments mapped: 764, into 103339 pages with 7230 pages pre-fetched<br>  total images loading time: 465.37 milliseconds (51.4%)<br>  total load time in ObjC:  44.48 milliseconds (4.9%)<br>  total debugger pause time: 296.13 milliseconds (32.7%)<br>  total dtrace DOF registration time:   0.10 milliseconds (0.0%)<br>  total rebase fixups:  2,520,346<br>  total rebase fixups time: 343.84 milliseconds (38.0%)<br>  total binding fixups: 283,141<br>  total binding fixups time:  18.27 milliseconds (2.0%)<br>  total weak binding fixups time:   0.41 milliseconds (0.0%)<br>  total redo shared cached bindings time:  25.48 milliseconds (2.8%)<br>  total bindings lazily fixed up: 0 of 0<br>  total time in initializers and ObjC +load:  31.52 milliseconds (3.4%)<br>                         libSystem.B.dylib :  12.06 milliseconds (1.3%)<br>               libBacktraceRecording.dylib :   2.54 milliseconds (0.2%)<br>                            CoreFoundation :   1.46 milliseconds (0.1%)<br>                                Foundation :   1.69 milliseconds (0.1%)<br>                libMainThreadChecker.dylib :  12.12 milliseconds (1.3%)<br>total symbol trie searches:    132718<br>total symbol table binary searches:    0<br>total images defining weak symbols:  20<br>total images using weak symbols:  61</p>
<p>对于这个 libMainThreadChecker.dylib 估计很多人会有点陌生，这是 XCode 9 新增的动态库，用来做主线成检查的。</p>
<h4 id="优化启动时间"><a href="#优化启动时间" class="headerlink" title="优化启动时间"></a>优化启动时间</h4><p>启动时间这个名词，不同的人有不同的定义。在我看来</p>
<blockquote>
<p>启动时间是用户点击 App 图标，到第一个界面展示的时间。</p>
</blockquote>
<p>以 main 函数作为分水岭，启动时间其实包括了两部分：main 函数之前和 main 函数到第一个界面的 viewDidAppear:。所以，优化也是从两个方面进行的，个人建议优先优化后者，因为绝大多数 App 的瓶颈在自己的代码里。</p>
<p><strong>Main 函数之后</strong></p>
<p>首先来分析下，从 main 函数开始执行，到你的第一个界面显示，这期间一般会做哪些事情。</p>
<ul>
<li>执行 AppDelegate 的代理方法，主要是 didFinishLaunchingWithOptions:</li>
<li>初始化 Window，初始化基础的 ViewController 结构（一般是 UINavigationController+UITabViewController）</li>
<li>获取数据（Local DB/Network），展示给用户。</li>
</ul>
<p><strong>UIViewController</strong></p>
<p>延迟初始化那些不必要的 UIViewController。</p>
<p>比如网易新闻：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-18849aaa2f395b29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>在启动的时候只需要初始化首页的头条页面即可。像”要闻”、”我的”等页面，则延迟加载，即启动的时候只是一个 Controller 作为占位符给 TabController，等到用户点击了再去进行真正的数据和视图的初始化工作。系统的 UITabBarController 已经这样做了，但是很多 App 都是自定义的。</p>
<h4 id="AppDelegate"><a href="#AppDelegate" class="headerlink" title="AppDelegate"></a>AppDelegate</h4><p>通常我们会在 AppDelegate 的代理方法里进行初始化工作，主要包括了两个方法：</p>
<ul>
<li>didFinishLaunchingWithOptions</li>
<li>applicationDidBecomeActive</li>
</ul>
<p>优化这些初始化的核心思想就是：</p>
<blockquote>
<p>能延迟初始化的尽量延迟初始化，不能延迟初始化的尽量放到后台初始化。</p>
</blockquote>
<p>这些工作主要可以分为几类：</p>
<ul>
<li>三方 SDK 初始化，比如 Crash 统计；像分享之类的，可以等到第一次调用再初始化。</li>
<li>初始化某些基础服务，比如 WatchDog，远程参数。</li>
<li>启动相关日志，日志往往涉及到 DB 操作，一定要放到后台去做</li>
<li>业务方初始化，这个交由每个业务自己去控制初始化时间。</li>
</ul>
<p>对于 didFinishLaunchingWithOptions: 的代码，建议按照以下的方式进行划分：</p>
<p>@interface AppDelegate ()<br>//业务方需要的生命周期回调<br>@property (strong, nonatomic) NSArray&lt;id<uiapplicationdelegate>&gt; * eventQueues;<br>//主框架负责的生命周期回调<br>@property (strong, nonatomic) id<uiapplicationdelegate> basicDelegate;<br>@end</uiapplicationdelegate></uiapplicationdelegate></p>
<p>然后，你会得到一个非常干净的 AppDelegate 文件：</p>
<p>- (BOOL)application:(UIApplication <em>)application didFinishLaunchingWithOptions:(NSDictionary </em>)launchOptions<br>{<br>    for (id<uiapplicationdelegate> delegate in self.eventQueues) {<br>        [delegate application:application didFinishLaunchingWithOptions:launchOptions];<br>    }<br>    return [self.basicDelegate application:application didFinishLaunchingWithOptions:launchOptions];<br>}</uiapplicationdelegate></p>
<p>由于对这些初始化进行了分组，在开发期就可以很容易的控制每一个业务的初始化时间：</p>
<p>CFTimeInterval startTime = CACurrentMediaTime();<br>// 执行方法<br>CFTimeInterval endTime = CACurrentMediaTime();</p>
<h4 id="用-Time-Profiler-找到元凶"><a href="#用-Time-Profiler-找到元凶" class="headerlink" title="用 Time Profiler 找到元凶"></a>用 Time Profiler 找到元凶</h4><p>Time Profiler 在分析时间占用上非常强大。实用的时候注意三点</p>
<ul>
<li>在打包模式下分析（一般是 Release），这样和线上环境一样。</li>
<li>记得开启 dsym，不然无法查看到具体的函数调用堆栈</li>
<li>分析性能差的设备，对于支持 iOS 8 的，一般分析 iphone 4s 或 iphone 5。</li>
</ul>
<p>一个典型的分析界面如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-26b18e51ba364cf7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Time Profiler"></p>
<p>几点要注意：</p>
<ol>
<li>分析启动时间，一般只关心主线程</li>
<li>选择 Hide System Libraries 和 Invert Call Tree，这样我们能专注于自己的代码</li>
<li>右侧可以看到详细的调用堆栈信息</li>
</ol>
<p>在某一行上双击，我们可以进入到代码预览界面，去看看实际每一行占用了多少时间：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-9dac1cac007ec660.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="TimeProfiler_Detail"></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>不同的 App 在启动的时候做的事情往往不同，但是优化起来的核心思想无非就两个：</p>
<ol>
<li>能延迟执行的就延迟执行。比如 SDK 的初始化、界面的创建。</li>
<li>不能延迟执行的，尽量放到后台执行。比如数据读取、原始 JSON 数据转对象、日志发送。</li>
</ol>
<h4 id="Main-函数之前"><a href="#Main-函数之前" class="headerlink" title="Main 函数之前"></a>Main 函数之前</h4><p>Main 函数之前是 iOS 系统的工作，所以这部分的优化往往更具有通用性。</p>
<p><strong>dylibs</strong></p>
<p>启动的第一步是加载动态库，加载系统的动态库是很快的，因为可以缓存，而加载内嵌的动态库速度较慢。所以，提高这一步的效率的关键是：减少动态库的数量。</p>
<p>合并动态库，比如公司内部由私有 Pod 建立了如下动态库：XXTableView、XXHUD、XXLabel，强烈建议合并成一个 XXUIKit来提高加载速度。</p>
<p><strong>Rebase &amp; Bind &amp; Objective-C Runtime</strong></p>
<p>Rebase 和 Bind 都是为了解决指针引用的问题。对于 Objective-C 开发来说，主要的时间消耗在 Class/Method 的符号加载上，所以常见的优化方案是：</p>
<ul>
<li>减少 __DATA 段中的指针数量。</li>
<li>合并 Category 和功能类似的类。比如：UIView+Frame、UIView+AutoLayout… 合并为一个</li>
<li>删除无用的方法和类。</li>
<li>多用 Swift Structs，因为 Swfit Structs 是静态分发的。</li>
</ul>
<p><strong>Initializers</strong></p>
<p>通常，我们会在 +load 方法中进行 method-swizzling，这也是 NSHipster 推荐的方式。</p>
<ul>
<li>用 initialize 替代 load。不少同学喜欢用 method-swizzling 来实现 AOP 去做日志统计等内容，强烈建议改为在 initialize 进行初始化。</li>
<li>减少 __atribute__((constructor)) 的使用，而是在第一次访问的时候才用 dispatch_once 等方式初始化。</li>
<li>不要创建线程</li>
<li>使用Swfit重写代码。</li>
</ul>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p>WWDC 2016: <a href="https://developer.apple.com/videos/play/wwdc2016/406" target="_blank" rel="noopener">Optimizing App Startup Time</a><br>WWDC 2017: <a href="https://developer.apple.com/videos/play/wwdc2017/413/" target="_blank" rel="noopener">App Startup Time: Past, Present, and Future</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/01/02/ios-app-e7-9a-84-e5-90-af-e5-8a-a8-e8-bf-87-e7-a8-8b/">http://yoursite.com/2019/01/02/ios-app-e7-9a-84-e5-90-af-e5-8a-a8-e8-bf-87-e7-a8-8b/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/01/10/opengl-5-e7-ba-b9-e7-90-86/" class="pre"> OpenGL - 5 纹理		</a><a href="/2019/01/02/e5-a4-9a-e4-b8-aa-e5-bc-82-e6-ad-a5-e7-bd-91-e7-bb-9c-e8-af-b7-e6-b1-82-e5-85-a8-e9-83-a8-e8-bf-94-e5-9b-9e/" class="next"> 多个异步网络请求全部返回		</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mach-O"><span class="toc-text">Mach-O</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dyld"><span class="toc-text">dyld</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Virtual-Memory"><span class="toc-text">Virtual Memory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Page-fault"><span class="toc-text">Page fault</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dirty-Page-amp-Clean-Page"><span class="toc-text">Dirty Page &amp; Clean Page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动过程"><span class="toc-text">启动过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加载动态库"><span class="toc-text">加载动态库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#"><span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Objective-C"><span class="toc-text">Objective-C</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Initializers"><span class="toc-text">Initializers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dyld3"><span class="toc-text">dyld3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动时间"><span class="toc-text">启动时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化启动时间"><span class="toc-text">优化启动时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AppDelegate"><span class="toc-text">AppDelegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用-Time-Profiler-找到元凶"><span class="toc-text">用 Time Profiler 找到元凶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结"><span class="toc-text">小结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Main-函数之前"><span class="toc-text">Main 函数之前</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#参考资料"><span class="toc-text">参考资料</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/13/WKWebView/">WKWebView</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/iOS 编译过程原理(2)/">iOS 编译过程原理(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/BFPRT算法/">BFPRT 算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/全排列/">全排列</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/01-背包/">0-1 背包</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/直接插入排序/">直接插入排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/armv7、armv7s、arm64/">armv7、armv7s、arm64</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/Archives配置/">Archives 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/App-Thinning/">App Thinning</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/AFNetworking/">AFNetworking</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AFNetworking/">AFNetworking</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GLSL/">GLSL</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Games/">Games</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/">Leetcode</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MJRefresh/">MJRefresh</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OC/">OC</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPENGL/">OPENGL</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactiveCocoa/">ReactiveCocoa</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SDWebImage/">SDWebImage</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpriteKit/">SpriteKit</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Xcode/">Xcode</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内存管理/">内存管理</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/减治法/">减治法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分治法/">分治法</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/动态规划/">动态规划</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/变治法/">变治法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/图像视频/">图像视频</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/多线程/">多线程</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工程发布/">工程发布</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/底层原理/">底层原理</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/性能优化/">性能优化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/排序算法/">排序算法</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/效率-工具/">效率 | 工具</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构设计/">架构设计</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法相关/">算法相关</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/视图-amp-动画/">视图 &amp; 动画</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计策略/">设计策略</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读源码/">阅读源码</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/排序算法/" style="font-size: 15px;">排序算法</a> <a href="/tags/动态规划/" style="font-size: 15px;">动态规划</a> <a href="/tags/分治法/" style="font-size: 15px;">分治法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://www.liaoxuefeng.com/" title="廖雪峰的官方网站" target="_blank">廖雪峰的官方网站</a><ul></ul><a href="https://blog.ibireme.com/" title="ibireme" target="_blank">ibireme</a><ul></ul><a href="https://www.cnblogs.com/machao/" title="马在路上" target="_blank">马在路上</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>