<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>消息转发 | D</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">消息转发</h1><a id="logo" href="/.">D</a><p class="description">While there is life there is hope</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">消息转发</h1><div class="post-meta"><a href="/2019/08/06/iOS/iOS原理/消息转发/#comments" class="comment-count"></a><p><span class="date">Aug 06, 2019</span><span><a href="/categories/iOS原理/" class="category">iOS原理</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>在开发过程中，可能遇到服务端返回数据中有 null，当取到 null 值并对 null 发送消息的时候，就可能出现  unrecognized selector sent to instance，导致应用 crash 的情况。</p>
<p>针对这种情况，在每次取值的时候去做判断处理又不大合适，在 GitHub上发现了 <a href="https://github.com/nicklockwood/NullSafe" target="_blank" rel="noopener">NullSafe</a>。把这个文件拖到项目中，即使出现 null 的情况，也不会报出 unrecognized selector sent to instance 的问题。</p>
<p>消息转发的整个过程主要涉及的 3 个方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+(<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel;</span><br><span class="line">-(<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector;</span><br><span class="line">-(<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span>*)anInvocation;</span><br></pre></td></tr></table></figure>
<p>其中在 +(BOOL)resolveInstanceMethod:(SEL)sel 的时候，会有相应的方法缓存操作，这个操作是系统帮我们做的。</p>
<h2 id="二、消息转发过程"><a href="#二、消息转发过程" class="headerlink" title="二、消息转发过程"></a>二、消息转发过程</h2><p>首先贴一张消息转发的图，笔者聊到的内容会围绕着这张图展开。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-21f16eb1cfa08e77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>下边分析消息转发的过程，以 [MyObjet Length] 为例：</p>
<p>①、首先 MyObjet 在调用 length 方法后，会先进行动态方法解析，调用 +(BOOL)resolveInstanceMethod:(SEL)sel，我们可以在这里动态添加方法，而且如果在这里动态添加方法成功后，系统会把动态添加的 length 方法进行缓存，当 MyObjet 再次调用 length 方法的时候，将不会调用 +(BOOL)resolveInstanceMethod:(SEL)sel。会直接调用动态添加成功的 length 方法。</p>
<p>②、如果动态方法解析部分没有做操作，或者动态添加方法失败了的话，会进行寻找备援接收者的过程 -(id)forwardingTargetForSelector:(SEL)aSelector，这个过程用于寻找一个接收者，可以响应未知的方法。</p>
<p>③、如果寻找备援接收者的过程中返回值为 nil 的话，那么会进入到完整的消息转发流程中。完整的消息转发流程：首先创建 NSInvocation 对象，把与尚未处理的那条消息有关的全部细节都封于其中，此对象包含选择子、目标（target）及参数。在出发 NSInvocation 对象时，“消息派发系统”（message-dispatch system）将亲自出马，把消息指派给目标对象。</p>
<h2 id="三、结合-MyObject-中的代码对消息转发流程进一步分析"><a href="#三、结合-MyObject-中的代码对消息转发流程进一步分析" class="headerlink" title="三、结合 MyObject 中的代码对消息转发流程进一步分析"></a>三、结合 MyObject 中的代码对消息转发流程进一步分析</h2><p>①、先看第一部分 MyObject 在调用 length 方法后，会先进行动态方法解析，调用 +(BOOL)resolveInstanceMethod:(SEL)sel，如果我们在这里为 MyObject 动态添加方法。那么也能处理消息。相关代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel </span><br><span class="line">&#123;    </span><br><span class="line">    printf(<span class="string">"%s:%s \n"</span>, __func__ ,<span class="built_in">NSStringFromSelector</span>(sel).UTF8String);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(length)) &#123;</span><br><span class="line">         <span class="built_in">BOOL</span> success = class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], sel, (IMP)(length), <span class="string">"q@:"</span>); </span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (success) &#123;</span><br><span class="line">             <span class="keyword">return</span> success;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传入的 “q@:” 分别代表：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">q : 返回值 <span class="keyword">long</span> <span class="keyword">long</span></span><br><span class="line">@ : 调用方法的的实例为对象类型</span><br><span class="line">: : 表示方法</span><br></pre></td></tr></table></figure>
<p>下图表示了编码类型。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5294842-a5925ae21f498603.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>②、MyObject 在调用 length 方法后，动态方法解析部分如果返回值为 NO 的时候，会寻找备援接收者，调用 -(id)forwardingTargetForSelector:(SEL)aSelector，如果我们在这里为返回可以处理 length 的接收者。那么也能处理消息。相关代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * respondClasses;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">"%s:%s \n"</span>, __func__ , <span class="built_in">NSStringFromSelector</span>(aSelector).UTF8String);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">id</span> forwardTarget = [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">    <span class="keyword">if</span> (forwardTarget) &#123;</span><br><span class="line">        <span class="keyword">return</span> forwardTarget;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class someClass = [<span class="keyword">self</span> myResponedClassForSelector:aSelector];</span><br><span class="line">    <span class="keyword">if</span> (someClass) &#123;</span><br><span class="line">        forwardTarget = [someClass new];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> forwardTarget;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (Class)myResponedClassForSelector:(SEL)selector</span><br><span class="line">&#123;</span><br><span class="line">    respondClasses = @[</span><br><span class="line">                       [<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSMutableDictionary</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSMutableString</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSNumber</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSDate</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSData</span> <span class="keyword">class</span>]</span><br><span class="line">                       ];</span><br><span class="line">    <span class="keyword">for</span> (Class someClass <span class="keyword">in</span> respondClasses) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([someClass instancesRespondToSelector:selector]) &#123;</span><br><span class="line">            <span class="keyword">return</span> someClass;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>+(BOOL)instancesRespondToSelector:(SEL)aSelector; 用于返回 Class 对应的实例能否响应 aSelector。</p>
<p>③、MyObject 在调用 length 方法后，动态方法解析部分如果返回值为 NO 的时候，寻找备援接收者的返回值为 nil 的时候，会进行完整的消息转发流程。调用 -(void)forwardInvocation:(NSInvocation *)anInvocation，这个过程会有一个插曲 -(NSMethodSignature *)methodSignatureForSelector:(SEL)selector，只有我们返回了相应地 NSMethodSignature 实例的时候，完整地消息转发流程才能得以顺利完成。</p>
<blockquote>
<p> -(NSMethodSignature*)methodSignatureForSelector:(SEL)selector。</p>
<p>摘抄自文档：This method is used in the implementation of protocols. This method is also used in situations where an NSInvocation object must be created, such as during message forwarding.If your object maintains a delegate or is capable of handling messages that it does not directly implement, you should override this method to return an appropriate method signature.</p>
<p>这个方法也会用于消息转发的时候，当 NSInvocation 对象必须创建的时候，如果我们的对象能够处理没有直接实现的方法，我们应该重写这个方法，返回一个合适的方法签名。</p>
</blockquote>
<p>相关代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">"%s:%s \n\n\n\n"</span>, __func__ , <span class="built_in">NSStringFromSelector</span>(anInvocation.selector).UTF8String);</span><br><span class="line"></span><br><span class="line">    anInvocation.target = <span class="literal">nil</span>;</span><br><span class="line">    [anInvocation invoke];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)selector &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *signature = [<span class="keyword">super</span> methodSignatureForSelector:selector];</span><br><span class="line">    <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">        Class responededClass = [<span class="keyword">self</span> myResponedClassForSelector:selector];</span><br><span class="line">        <span class="keyword">if</span> (responededClass) &#123;</span><br><span class="line">            <span class="keyword">@try</span> &#123;</span><br><span class="line">                signature = [responededClass instanceMethodSignatureForSelector:selector];</span><br><span class="line">            &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">@finally</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)myResponedClassForSelector:(SEL)selector &#123;</span><br><span class="line"></span><br><span class="line">    respondClasses = @[</span><br><span class="line">                       [<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSMutableDictionary</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSMutableString</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSNumber</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSDate</span> <span class="keyword">class</span>],</span><br><span class="line">                       [<span class="built_in">NSData</span> <span class="keyword">class</span>]</span><br><span class="line">                       ];</span><br><span class="line">    <span class="keyword">for</span> (Class someClass <span class="keyword">in</span> respondClasses) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([someClass instancesRespondToSelector:selector]) &#123;</span><br><span class="line">            <span class="keyword">return</span> someClass;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个不常用的 API：+(NSMethodSignature *)instanceMethodSignatureForSelector:(SEL)aSelector;，这个 API 通过 Class 及给定的 aSelector 返回一个包含实例方法标识描述的方法签名实例。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSMethodSignature</span>: <span class="number">0x6000030a17c0</span>&gt;</span><br><span class="line">    number of arguments = <span class="number">2</span></span><br><span class="line">    frame size = <span class="number">224</span></span><br><span class="line">    is special <span class="keyword">struct</span> <span class="keyword">return</span>? <span class="literal">NO</span></span><br><span class="line">    <span class="keyword">return</span> value: -------- -------- -------- --------</span><br><span class="line">        type encoding (f) <span class="string">'f'</span></span><br><span class="line">        flags &#123;isFloat&#125;</span><br><span class="line">        modifiers &#123;&#125;</span><br><span class="line">        frame &#123;offset = <span class="number">16</span>, offset adjust = <span class="number">0</span>, size = <span class="number">16</span>, size adjust = <span class="number">-12</span>&#125;</span><br><span class="line">        memory &#123;offset = <span class="number">0</span>, size = <span class="number">4</span>&#125;</span><br><span class="line">    argument <span class="number">0</span>: -------- -------- -------- --------</span><br><span class="line">        type encoding (@) <span class="string">'@'</span></span><br><span class="line">        flags &#123;isObject&#125;</span><br><span class="line">        modifiers &#123;&#125;</span><br><span class="line">        frame &#123;offset = <span class="number">0</span>, offset adjust = <span class="number">0</span>, size = <span class="number">8</span>, size adjust = <span class="number">0</span>&#125;</span><br><span class="line">        memory &#123;offset = <span class="number">0</span>, size = <span class="number">8</span>&#125;</span><br><span class="line">    argument <span class="number">1</span>: -------- -------- -------- --------</span><br><span class="line">        type encoding (:) <span class="string">':'</span></span><br><span class="line">        flags &#123;&#125;</span><br><span class="line">        modifiers &#123;&#125;</span><br><span class="line">        frame &#123;offset = <span class="number">8</span>, offset adjust = <span class="number">0</span>, size = <span class="number">8</span>, size adjust = <span class="number">0</span>&#125;</span><br><span class="line">        memory &#123;offset = <span class="number">0</span>, size = <span class="number">8</span>&#125;</span><br><span class="line">```        </span><br><span class="line"></span><br><span class="line"><span class="built_in">NSInvocation</span>。</span><br><span class="line"></span><br><span class="line">仍然以`myObject`调用`length`方法为例。 \- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> \*)anInvocation中的 anInvocation 的信息如下：</span><br><span class="line"></span><br><span class="line">```objc</span><br><span class="line">&lt;<span class="built_in">NSInvocation</span>: <span class="number">0x6000025b8140</span>&gt;</span><br><span class="line"><span class="keyword">return</span> value: &#123;Q&#125; <span class="number">0</span></span><br><span class="line">target: &#123;@&#125; <span class="number">0x60000322c360</span></span><br><span class="line">selector: &#123;:&#125; length</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">return</span> value 指返回值，<span class="string">"Q"</span> 表示返回值类型为 <span class="keyword">long</span> <span class="keyword">long</span> 类型；</span><br><span class="line">&gt; target 指的是消息的接收者，<span class="string">"@"</span>标识对象类型；</span><br><span class="line">&gt; selector 指的是方法，<span class="string">":"</span>表示是方法，后边的 length 为方法名。</span><br></pre></td></tr></table></figure>
<p>更多内容可见下图 NSInvocation 的 types：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> _NSObjCValueType &#123;</span><br><span class="line">    <span class="built_in">NSObjCNoType</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="built_in">NSObjCVoidType</span> = <span class="string">'v'</span>,</span><br><span class="line">    <span class="built_in">NSObjCCharType</span> = <span class="string">'c'</span>,</span><br><span class="line">    <span class="built_in">NSObjCShortType</span> = <span class="string">'s'</span>,</span><br><span class="line">    <span class="built_in">NSObjCLongType</span> = <span class="string">'l'</span>,</span><br><span class="line">    <span class="built_in">NSObjCLonglongType</span> = <span class="string">'q'</span>,</span><br><span class="line">    <span class="built_in">NSObjCFloatType</span> = <span class="string">'f'</span>,</span><br><span class="line">    <span class="built_in">NSObjCDoubleType</span> = <span class="string">'d'</span>,</span><br><span class="line">    <span class="built_in">NSObjCBoolType</span> = <span class="string">'B'</span>,</span><br><span class="line">    <span class="built_in">NSObjCSelectorType</span> = <span class="string">':'</span>,</span><br><span class="line">    <span class="built_in">NSObjCObjectType</span> = <span class="string">'@'</span>,</span><br><span class="line">    <span class="built_in">NSObjCStructType</span> = <span class="string">'&#123;'</span>,</span><br><span class="line">    <span class="built_in">NSObjCPointerType</span> = <span class="string">'^'</span>,</span><br><span class="line">    <span class="built_in">NSObjCStringType</span> = <span class="string">'*'</span>,</span><br><span class="line">    <span class="built_in">NSObjCArrayType</span> = <span class="string">'['</span>,</span><br><span class="line">    <span class="built_in">NSObjCUnionType</span> = <span class="string">'('</span>,</span><br><span class="line">    <span class="built_in">NSObjCBitfield</span> = <span class="string">'b'</span></span><br><span class="line">&#125; API_DEPRECATED(<span class="string">"Not supported"</span>, macos(<span class="number">10.0</span>,<span class="number">10.5</span>), ios(<span class="number">2.0</span>,<span class="number">2.0</span>), watchos(<span class="number">2.0</span>,<span class="number">2.0</span>), tvos(<span class="number">9.0</span>,<span class="number">9.0</span>));</span><br></pre></td></tr></table></figure>
<h2 id="四、尚存疑点"><a href="#四、尚存疑点" class="headerlink" title="四、尚存疑点"></a>四、尚存疑点</h2><p>细心的读者可能会发现在首次消息转发的时候流程并不是</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+[MyObject resolveInstanceMethod:]:length </span><br><span class="line">-[MyObject forwardingTargetForSelector:]:length </span><br><span class="line">-[MyObject forwardInvocation:]:length</span><br></pre></td></tr></table></figure>
<p>而是</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+[MyObject resolveInstanceMethod:]:length </span><br><span class="line">-[MyObject forwardingTargetForSelector:]:length </span><br><span class="line">+[MyObject resolveInstanceMethod:]:length </span><br><span class="line">+[MyObject resolveInstanceMethod:]:_forwardStackInvocation: </span><br><span class="line">-[MyObject forwardInvocation:]:length</span><br></pre></td></tr></table></figure>
<p>查看了开源源码 <a href="https://opensource.apple.com/source/objc4/objc4-750.1/runtime/NSObject.mm.auto.html" target="_blank" rel="noopener">NSObject.mm</a> 相关源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Replaced by CF (returns an NSMethodSignature)</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    _objc_fatal(&quot;-[NSObject methodSignatureForSelector:] &quot;</span><br><span class="line">                &quot;not available without CoreFoundation&quot;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)invocation &#123;</span><br><span class="line">    [self doesNotRecognizeSelector:(invocation ? [invocation selector] : 0)];</span><br><span class="line">&#125;</span><br><span class="line">// Replaced by CF (throws an NSException)</span><br><span class="line">- (void)doesNotRecognizeSelector:(SEL)sel &#123;</span><br><span class="line">    _objc_fatal(&quot;-[%s %s]: unrecognized selector sent to instance %p&quot;, </span><br><span class="line">                object_getClassName(self), sel_getName(sel), self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="五、NSNull-QiNullSafe-m"><a href="#五、NSNull-QiNullSafe-m" class="headerlink" title="五、NSNull+QiNullSafe.m"></a>五、NSNull+QiNullSafe.m</h2><p>根据 <a href="https://github.com/nicklockwood/NullSafe" target="_blank" rel="noopener">NullSafe</a> 仿写的 <a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FQiShare%2FQiSafeType%2Fblob%2Fmaster%2FQiSafeType%2FNullSafe%2FNSNull%252BQiNullSafe.m" target="_blank" rel="noopener">NSNull+QiNullSafe.m</a>。</p>
<p>NSNull+QiNullSafe.m 能够避免的问题有：</p>
<blockquote>
<p>NSNull *null = [NSNull null];</p>
<p>[null performSelector:@selector(addObject:) withObject:@”aaa”];<br>[null performSelector:@selector(setValue:forKey:) withObject:@”aaa”];<br>[null performSelector:@selector(valueForKey:) withObject:@”aaa”];<br>[null performSelector:@selector(length) withObject:nil];<br>[null performSelector:@selector(integerValue) withObject:nil];<br>[null performSelector:@selector(timeIntervalSinceNow) withObject:nil];<br>[null performSelector:@selector(bytes) withObject:nil];</p>
</blockquote>
<h2 id="六、NullSafe-是怎么处理-null-问题"><a href="#六、NullSafe-是怎么处理-null-问题" class="headerlink" title="六、NullSafe 是怎么处理 null 问题"></a>六、NullSafe 是怎么处理 null 问题</h2><p>其实 <a href="https://github.com/nicklockwood/NullSafe" target="_blank" rel="noopener">NullSafe</a>  处理 null 问题用的是消息转发的第三部分，走的是完整地消息转发流程。</p>
<p>不过我们开发过程中，如果可以的话，还是尽可能早地处理消息转发这部分，比如在动态方法解析的时候，动态添加方法（毕竟这一步系统可以为我们做方法的缓存处理）。 或者是在寻找备援接收对象的时候，返回能够响应未实现的方法的对象。</p>
<p>注意：相关的使用场景在测试的时候不要用，测试的时候尽可能还是要暴露出问题的。并且使用的时候，最好结合着异常日志上报。</p>
<h2 id="七、单元测试"><a href="#七、单元测试" class="headerlink" title="七、单元测试"></a>七、单元测试</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testStringValue</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> null = [<span class="built_in">NSNull</span> null];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> * string = [null stringValue];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">XCTAssertNil</span>(string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testFloatValue</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> null = [<span class="built_in">NSNull</span> null];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> f = [null floatValue];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">XCTAssertEqualWithAccuracy</span>(f, <span class="number">0.0</span>f, <span class="number">0.0</span>f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testPerformSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSNull</span> * null = [<span class="built_in">NSNull</span> null];</span><br><span class="line">    [null performSelector:<span class="keyword">@selector</span>(addObject:) withObject:<span class="string">@"aaa"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="八、文章"><a href="#八、文章" class="headerlink" title="八、文章"></a>八、文章</h2><p><a href="https://juejin.im/post/5c6e773be51d451b25716d0e" target="_blank" rel="noopener">iOS 消息转发</a></p>
<p><a href="http://www.olinone.com/?p=643" target="_blank" rel="noopener">Protocol 协议分发器</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: BiYJ</p><p>原文链接: <a href="http://yoursite.com/2019/08/06/iOS/iOS原理/消息转发/">http://yoursite.com/2019/08/06/iOS/iOS原理/消息转发/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/08/06/算法/汉诺塔/" class="pre">汉诺塔</a><a href="/2019/08/06/算法/求第 k 小:大元素/" class="next">第 k 小/大元素</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、前言"><span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、消息转发过程"><span class="toc-text">二、消息转发过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、结合-MyObject-中的代码对消息转发流程进一步分析"><span class="toc-text">三、结合 MyObject 中的代码对消息转发流程进一步分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、尚存疑点"><span class="toc-text">四、尚存疑点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、NSNull-QiNullSafe-m"><span class="toc-text">五、NSNull+QiNullSafe.m</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、NullSafe-是怎么处理-null-问题"><span class="toc-text">六、NullSafe 是怎么处理 null 问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、单元测试"><span class="toc-text">七、单元测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、文章"><span class="toc-text">八、文章</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS音视频/图片处理/">图片处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS音视频/Premultiplied Alpha/">Premultiplied Alpha</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS架构/垃圾代码/">添加垃圾代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/pthread_rwlock_t/">pthread_rwlock_t</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD实现/">GCD实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD/">GCD</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS多线程/GCD深入/">GCD深入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/iOS/iOS原理/NSProxy/">NSProxy</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/iOS/iOS架构/组件化方案/">组件化方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/iOS/iOS原理/iOS 编译过程原理(1)/">iOS 编译过程原理(1)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS优化/">iOS优化</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS原理/">iOS原理</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS多线程/">iOS多线程</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS架构/">iOS架构</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS音视频/">iOS音视频</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读源码/">阅读源码</a><span class="category-list-count">1</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p> 
京ICP备 - <a target="_blank" href="http://www.beian.miit.gov.cn">19039713号</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">BiYJ.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>