---
title: iOS IM
categories: iOS原理
---


## 发送图片、语音等

[有人知道语音留言聊天等大文件或大数据量的主流实现方式吗？](http://www.52im.net/thread-175-1-1.html)

> A：移动网络因为网络不稳定的客观因素存在，不适合实时发送较大的2进制文件（像电脑上的实时文件发送的那种），因为这涉及3方：客户端A、服务端、客户端B，任何两方的通讯因网络的不稳定而导致的重传等，都是个很不好处理的事情。
>
>现在多数情况下都是通过http先上传到中转文件服务器，成功后再通知接收方，这种情况下，因上传的过程只限于客户端A和服务端，只涉及两方，网络的不稳定，也只影响了发送者（而不涉及接收者，因为对方还不知道你正在发送文件呢），所以无论是从可靠性、复杂性，还是用户体验的处理上，这种方式都要简单的多。而这么多年的移动应用也证明，这种云中转暂存的方式是比较适合于当前的移动网络和移动应用体验的。
>
>Q：如果使用中转服务器，就有一个问题，， 就是收到音频信息后是直接显示那条音频消息，还是下载完再显示音频，如果直接显示音频，那用户点击的时候可能没有下载完成，点击没有声音。如果 下载完音频再显示消息的话，那么在下载过程中可能收到普通消息，普通消息不需要下载直接显示，这时候音频下载完成后显示在普通消息的后面的话顺序就乱了，显示在普通消息之前的话会有界面跳动的情况，用户体验不太好，这个问题怎么解决。
>
>A：应该是发送方把语音文件上传到服务器成功后，同时发一条语音消息（只是一个包含了音频下载地址信息，可能是个文件名或url）发给接收方，接收方只在点击时才下载。
>
>这就完全不存在你说的会乱序的问题。而且你仔细体验一下微信或其它主流im，都是这么玩的。你如果做过技术研究，就可以知道，微信最长 60 秒的语音留言大约 50KB 左右，你自已实现的话也差不多可以到90KB，而通常情况下没有人会说这么长的话，通常都是15秒左右，10 几 20kb 的文件大小，上传或下载都是非常轻松和快速的事情，所以，实际情况下的实用性，不需要怀疑。你可以去体验下 [RainbowChat](http://www.52im.net/forum-90-1.html)，即使是在很差的网络，比如在地铁行驶时使用，也同样体验很好。
>
>A2：发送图片、录音、录像的思路是：先通过 http 上传图片，录音，录像到服务端，然后要求服务端返回图片录音录像的地址到客户端，然后客户端发送 json，发送图片地址录音录像的地址给 IM，IM 通过推送给另外的客户端，客户端收到以后，通过解析 json，然后通过 http 下载视频图片、语音，图片的话要进行缩放，录音的华，要有特定的图标标示，录像的话，下载以后截取第一帧的图片，不过建议这样，在展示图片的时候，缩放，在展示录像录音的时候，直接用图标替代展示的录像录音，然后通过用户点击图标通过http下载录音视频得到这种效果，此类功能需要一个ftp服务器，进行处理

